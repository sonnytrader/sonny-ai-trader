<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonny AI Trader (V46.2 - V14 Aray√ºz√º D√ºzeltmesi)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        /* --- V14.9'dan Gelen Stil (D√ºzeltilmi≈ü) --- */
        :root {
            --bg-color: #0d1117; --card-bg: #161b22; --border-color: #30363d;
            --text-color: #c9d1d9; --text-color-secondary: #8b949e;
            --green: #28a745; --red: #dc3545; --grey: #484f58;
            --green-bg: #1a3a24; --red-bg: #411c22; --grey-bg: #21262d; --blue: #1f6feb;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 15px; font-size: 0.9rem;
        }
        .container-fluid { padding: 0; }
        
        header {
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 10px;
            background-color: var(--card-bg); padding: 15px; border-radius: 8px;
            border: 1px solid var(--border-color); flex-shrink: 0;
        }
        @media (min-width: 768px) { header { flex-direction: row; justify-content: space-between; align-items: center; } }
        
        header h1 { color: var(--green); margin: 0; font-size: 1.6em; }
        
        #scan-status {
            font-size: 1.1em; font-weight: 500; padding: 10px; border-radius: 6px;
            background-color: var(--bg-color); border: 1px solid var(--border-color);
            text-align: center; flex-grow: 1; min-width: 200px;
        }
        .manual-analysis {
            display: flex; gap: 10px; flex-grow: 1;
        }
        .manual-analysis input[type="text"] {
            flex-grow: 1; padding: 10px 12px; font-size: 1em; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--text-color); border-radius: 6px; min-width: 150px;
        }
        .manual-analysis button {
            padding: 10px 18px; font-size: 1em; font-weight: 600; background-color: var(--blue);
            color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; white-space: nowrap;
        }
        .manual-analysis button:hover { background-color: #388bfd; }
        .manual-analysis button:disabled { background-color: var(--grey); cursor: not-allowed; }

        #manual-result-wrapper { 
            position: relative; padding: 15px; margin-top: 10px; border-radius: 6px; 
            background-color: #0d1117; border: 1px solid var(--border-color);
            display: none; font-size: 0.9em;
        }
        .manual-close-btn { position: absolute; top: 5px; right: 10px; background: none; border: none; color: #ccc; font-size: 1.5em; cursor: pointer; }
        .manual-result-title { font-weight: bold; margin-bottom: 8px; color: var(--blue); font-size: 1.1em;}
        .manual-result-text p { margin-bottom: 0.5rem; }

        .table-container {
            margin-top: 1.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        h2 {
            font-size: 1.2rem; color: var(--text-color); margin: 0;
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
        }

        .filter-section { 
            padding: 10px 20px; background-color: #0d1117; 
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap; 
            border-bottom: 1px solid var(--border-color);
        }
        .filter-section label { font-weight: bold; font-size: 0.9em; margin-right: 5px;} 
        .filter-section input[type="number"] { width: 60px; padding: 5px; background-color: #333; border: 1px solid var(--border-color); border-radius: 4px; color: #fff; font-size: 0.9em; } 
        .filter-section button { padding: 5px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; font-size: 0.9em;}
        #apply-filter-button { background-color: var(--green); } 
        #show-all-button { background-color: var(--grey); }
        
        .btn-filter { background-color: #21262d; color: #ccc; border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 0.8em; }
        .btn-filter.active { background-color: var(--blue); color: white; border-color: var(--blue); } 
        .btn-filter:hover { background-color: #30363d; }

        .table-wrapper { overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 0; table-layout: auto; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        th { background-color: #161b22; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 10; font-size: 0.9em;}
        th:hover { background-color: #21262d; }
        th .sort-icon { margin-left: 5px; font-size: 0.8em; }
        tbody tr { background-color: var(--card-bg); }
        tbody tr:hover { background-color: #21262d; }
        
        .main-signal-table th:nth-child(1), .main-signal-table td:nth-child(1) { width: 65px; } 
        .main-signal-table th:nth-child(2), .main-signal-table td:nth-child(2) { width: 170px; } 
        .main-signal-table th:nth-child(3), .main-signal-table td:nth-child(3) { width: 120px; text-align: center; } 
        .main-signal-table th:nth-child(4), .main-signal-table td:nth-child(4) { width: 75px; text-align: right;} 
        .main-signal-table th:nth-child(5), .main-signal-table td:nth-child(5) { width: 100px; text-align: right;} 
        .main-signal-table th:nth-child(6), .main-signal-table td:nth-child(6) { width: 170px; } 
        .main-signal-table th:nth-child(7), .main-signal-table td:nth-child(7) { width: 70px; text-align: right;} 
        .main-signal-table th:nth-child(8), .main-signal-table td:nth-child(8) { width: 140px; } 
        .main-signal-table th:nth-child(9), .main-signal-table td:nth-child(9) { width: auto; white-space: normal !important; min-width: 300px; } 
        
        .momentum-table th:nth-child(1), .momentum-table td:nth-child(1) { width: 65px; } 
        .momentum-table th:nth-child(2), .momentum-table td:nth-child(2) { width: 130px; } 
        .momentum-table th:nth-child(3), .momentum-table td:nth-child(3) { width: 120px; text-align: center; } 
        .momentum-table th:nth-child(4), .momentum-table td:nth-child(4) { width: 100px; text-align: right; } 
        .momentum-table th:nth-child(5), .momentum-table td:nth-child(5) { width: auto; min-width: 300px; } 

        .watchlist-table th:nth-child(1), .watchlist-table td:nth-child(1) { width: 65px; } 
        .watchlist-table th:nth-child(2), .watchlist-table td:nth-child(2) { width: 120px; } 
        .watchlist-table th:nth-child(3), .watchlist-table td:nth-child(3) { width: 100px; text-align: center; } 
        .watchlist-table th:nth-child(4), .watchlist-table td:nth-child(4) { width: 100px; text-align: right; } 
        .watchlist-table th:nth-child(5), .watchlist-table td:nth-child(5) { width: 150px; } 
        .watchlist-table th:nth-child(6), .watchlist-table td:nth-child(6) { width: 70px; text-align: right; } 
        .watchlist-table th:nth-child(7), .watchlist-table td:nth-child(7) { width: 100px; } 
        .watchlist-table th:nth-child(8), .watchlist-table td:nth-child(8) { width: auto; white-space: normal !important; min-width: 250px;} 
        .watchlist-table th:nth-child(9), .watchlist-table td:nth-child(9) { width: 80px; text-align: center;} 

        .price-up { color: var(--green); font-weight: bold; }
        .price-down { color: var(--red); font-weight: bold; }
        
        .link-text { color: #58a6ff; text-decoration: none; } .link-text:hover { text-decoration: underline; }
       
        .compact-signal { padding: 4px 8px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .signal-long { background-color: var(--green-bg); color: var(--green); border: 1px solid var(--green);}
        .signal-short { background-color: var(--red-bg); color: var(--red); border: 1px solid var(--red);}
        .signal-pump { background-color: var(--green-bg); color: var(--green); border: 1px solid var(--green);}
        .signal-dump { background-color: var(--red-bg); color: var(--red); border: 1px solid var(--red);}
        .signal-beklemede { background-color: var(--grey-bg); color: var(--text-color-secondary); border: 1px solid var(--grey);}
        .status-reddet { background-color: #33231f; color: #793722; border: 1px solid #793722;}

        .teyit-uyumlu { color: var(--green); font-weight: bold; } 
        .teyit-zayif { color: #eac54f; font-weight: bold; } 
        .teyit-ters { color: var(--red); font-weight: bold; } 
        
        .scrollable-table { max-height: 450px; overflow-y: auto; }
        #momentum-table-container.scrollable-table { max-height: 300px; } 
        #signal-table-container.scrollable-table { max-height: 600px; } 
        #watchlist-table-container.scrollable-table { max-height: 350px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 4px; } ::-webkit-scrollbar-thumb { background: var(--grey); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--text-color-secondary); }
    </style>
</head>
<body>

    <div class="container-fluid">
        <header>
            <h1>Sonny AI Trader (V46.1 - V14 Aray√ºz√º)</h1>
            <div id="scan-status">Sunucuya baƒülanƒ±lƒ±yor...</div>
            <div class="manual-analysis">
                <input type="text" id="symbolInput" placeholder="Manuel Analiz & Takip Et (√∂rn: BTC)">
                <button id="analyzeButton">Analiz Et & Takip Et</button>
            </div>
            <div id="manual-result-wrapper">
                <button class="manual-close-btn" id="manual-close-btn">&times;</button>
                <div id="manual-result"></div>
            </div>
        </header>

        <div class="table-container">
            <h2>‚ö° Anlƒ±k Sinyaller (1H Momentum)</h2>
            <div id="momentum-table-container" class="table-wrapper scrollable-table">
                <table class="momentum-table">
                    <thead> <tr> <th>Zaman</th> <th>Sembol</th> <th>Sinyal</th> <th>Giri≈ü</th> <th>A√ßƒ±klama / Taktik</th> </tr> </thead>
                    <tbody id="momentum-table-body"> 
                        <tr><td colspan="5" class="text-center text-muted py-3">Hen√ºz momentum sinyali yok.</td></tr> 
                    </tbody>
                </table>
            </div>
        </div>

        <div class="table-container">
            <h2>‚ù§Ô∏è Takip Listesi (Watchlist)</h2>
            <div id="watchlist-table-container" class="table-wrapper scrollable-table">
                <table class="watchlist-table">
                    <thead> <tr> <th data-sort-wl="timestamp">Zaman</th> <th data-sort-wl="symbol">Sembol (Strateji)</th> <th data-sort-wl="signal">Y√∂n</th> <th>Giri≈ü Fiyatƒ±</th> <th>TP / SL</th> <th data-sort-wl="RR">R/R</th> <th data-sort-wl="volumeStatus">Hacim</th> <th class="reason-cell">A√ßƒ±klama</th> <th>ƒ∞≈ülem</th> </tr> </thead>
                    <tbody id="watchlist-table-body"> <tr><td colspan="9" class="text-center text-muted py-3">Liste bo≈ü veya y√ºkleniyor...</td></tr> </tbody>
                </table>
            </div>
        </div>

        <div class="table-container">
            <h2>üìà Bekleyen Kurulumlar (1H, 2H, 4H Kƒ±rƒ±lƒ±m)</h2>
            <div class="filter-section">
                <label for="confidence-threshold">Min. G√ºven:</label>
                <input type="number" id="confidence-threshold" value="0" min="0" max="100">
                <button id="apply-filter-button">Filtrele</button>
                <button id="show-all-button">T√ºm√ºn√º G√∂ster</button>
                <div style="margin-left: auto;">
                    <button class="btn btn-filter active" id="filter-all" data-strategy="ALL">T√úM√ú (BRK)</button>
                    <button class="btn btn-filter" data-strategy="BRK1H">KIRILIM 1H</button>
                    <button class="btn btn-filter" data-strategy="BRK2H">KIRILIM 2H</button>
                    <button class="btn btn-filter" data-strategy="BRK4H">KIRILIM 4H</button>
                </div>
            </div>
            <div id="signal-table-container" class="table-wrapper scrollable-table">
                <table class="main-signal-table">
                    <thead> <tr> <th data-sort="timestamp" class="sorted-asc">Zaman <span class="sort-icon">&#9660;</span></th> <th data-sort="symbol">Sembol (Strateji)</th> <th data-sort="signal">Y√∂n</th> <th data-sort="confidence">G√ºven %</th> <th>Tetikleme Fiyatƒ±</th> <th>TP / SL</th> <th data-sort="RR">R/R</th> <th class="volume-header">Hacim</th> <th class="reason-cell">A√ßƒ±klama / Strateji</th> </tr> </thead>
                    <tbody id="signal-table-body"> <tr><td colspan="9" class="text-center text-muted py-3">Hen√ºz kurulum sinyali yok veya y√ºkleniyor...</td></tr> </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL DEƒûƒ∞≈ûKENLER ---
        const socket = io();
        const signalTableBody = document.getElementById('signal-table-body');
        const momentumTableBody = document.getElementById('momentum-table-body');
        const watchlistTableBody = document.getElementById('watchlist-table-body');
        const symbolInput = document.getElementById('symbolInput');
        const analyzeButton = document.getElementById('analyzeButton');
        const manualResultWrapper = document.getElementById('manual-result-wrapper');
        const manualResultDiv = document.getElementById('manual-result');
        const manualCloseBtn = document.getElementById('manual-close-btn');
        const confidenceThresholdInput = document.getElementById('confidence-threshold');
        const applyFilterButton = document.getElementById('apply-filter-button');
        const showAllButton = document.getElementById('show-all-button');
        const scanStatusText = document.getElementById('scan-status-text');
        const scanSpinner = document.getElementById('scan-spinner');

        // V46.1 HATA D√úZELTMESƒ∞: Sunucudaki gibi ayrƒ± listeler tutulacak
        let allSignals = {}; // Kƒ±rƒ±lƒ±m sinyalleri (BRK1H, 2H, 4H)
        let momentumSignals = {}; // Momentum sinyalleri (MOMENTUM1H)
        
        let currentWatchlist = {}; 
        const MAX_SIGNALS = 150; 
        let mainSortState = { key: 'timestamp', direction: 'desc' }; 
        let wlSortState = { key: 'timestamp', direction: 'desc' };
        let currentThreshold = 0; 
        let activeStrategyFilter = 'ALL';

        // --- Yardƒ±mcƒ± Fonksiyonlar ---
        function formatTimestamp(timestamp) { if (!timestamp) return '---'; try { return new Date(timestamp).toLocaleTimeString('tr-TR'); } catch (e) { return 'Invalid Date'; } }
        
        function getStrategyTag(strategyType) {
            if (!strategyType) return '';
            if (strategyType === 'MOMENTUM1H') return '<span class="strategy-momentum1h">(1H Momentum)</span>';
            if (strategyType === 'BRK1H') return '<span class="strategy-brk1h">(1H Kƒ±rƒ±lƒ±m)</span>'; 
            if (strategyType === 'BRK2H') return '<span class="strategy-brk2h">(2H Kƒ±rƒ±lƒ±m)</span>'; 
            if (strategyType === 'BRK4H') return '<span class="strategy-brk4h">(4H Kƒ±rƒ±lƒ±m)</span>'; 
            if (strategyType === 'MANUAL' || strategyType === 'WATCHLIST_WAIT') return '<span class="strategy-stochema">(Takip)</span>';
            return `<span class="strategy-stochema">(${strategyType})</span>`;
        }

        function getVolumeClassAndText(signal) { 
            let text = signal?.volumeStatus || '---'; 
            
            if(signal?.strategyType === 'MOMENTUM1H' && signal.reason) {
                 text = signal.reason; // "Hacim: 5.2x, Fiyat Deƒü: 1.52%"
            }

            return `<span class="volume-span">${text}</span>`; 
        }

        function formatReasonText(reason) { 
            if (!reason) return '---'; 
            try { 
                reason = reason.replace(/\*\*TETƒ∞KLEME Fƒ∞YATI: (.*?)\*\*/g, '<span class="teyit-uyumlu">TETƒ∞KLEME Fƒ∞YATI: $1</span>'); 
                reason = reason.replace(/\*\*ANLIK Gƒ∞Rƒ∞≈û:(.*?)\*\*/g, '<span class="teyit-uyumlu">ANLIK Gƒ∞Rƒ∞≈û:$1</span>'); 
                reason = reason.replace(/Aktif kurulum bulunamadƒ±. Takip ediliyor.../g, '<span style="color:#adb5bd;">Aktif kurulum bulunamadƒ±. Takipte...</span>');
                
                reason = reason.replace(/‚úÖ \*\*Trend Dostu Sinyal/g, '<span class="status-onay">‚úÖ Trend Dostu</span>');
                reason = reason.replace(/‚ö†Ô∏è \*\*Y√ºksek Risk \(Ters Trend\)!/g, '<span class="teyit-ters">‚ö†Ô∏è Ters Trend!</span>');
                reason = reason.replace(/üêã \*\*'Balina Teyitli/g, '<span class="status-onay">üêã Balina Teyitli</span>');
                reason = reason.replace(/üëç \*\*Hacim Teyitli/g, '<span class="teyit-uyumlu">üëç Hacim Teyitli</span>');
                reason = reason.replace(/üëé \*\*Zayƒ±f Hacim/g, '<span class="teyit-zayif">üëé Zayƒ±f Hacim</span>');
                reason = reason.replace(/ü•µ \*\*A≈üƒ±rƒ± ≈ûi≈ümi≈ü/g, '<span class="teyit-ters">ü•µ A≈üƒ±rƒ± ≈ûi≈ümi≈ü</span>');
                reason = reason.replace(/ü•∂ \*\*A≈üƒ±rƒ± Satƒ±lmƒ±≈ü/g, '<span class="teyit-ters">ü•∂ A≈üƒ±rƒ± Satƒ±lmƒ±≈ü</span>');
                reason = reason.replace(/üí™ \*\*Momentum ƒ∞yi/g, '<span class="teyit-uyumlu">üí™ Momentum ƒ∞yi</span>');
                reason = reason.replace(/‚è≥ \*\*Sƒ±kƒ±≈üma Patlamasƒ±/g, '<span class="teyit-uyumlu">‚è≥ Sƒ±kƒ±≈üma Patlamasƒ±</span>');

                reason = reason.replace(/Fƒ∞LTRELENDƒ∞/g, '<span class="teyit-ters">Fƒ∞LTRELENDƒ∞</span>'); 
                
                return reason; 
            } catch(e){ console.error("Reason Format Error:", e); return reason; }
        }

        // --- Tablo G√ºncelleme Fonksiyonlarƒ± ---
        function renderMainSignals() {
            try { 
                const signalsArray = Object.values(allSignals);
                sortSignals(signalsArray, mainSortState.key, mainSortState.direction); 
                signalTableBody.innerHTML = ''; 
                
                const filteredSignals = signalsArray.filter(signal => { 
                    if (!signal || typeof signal.confidence === 'undefined') return false; 
                    
                    const confidence = parseInt(signal.confidence); 
                    const passesConfidence = confidence >= currentThreshold; 
                    
                    const strategyCode = signal.strategyType || 'ALL';
                    let passesStrategyFilter = activeStrategyFilter === 'ALL';
                    
                    if (strategyCode === 'MOMENTUM1H') {
                         passesStrategyFilter = (activeStrategyFilter === 'ALL' || activeStrategyFilter === 'MOMENTUM1H');
                    } else {
                         passesStrategyFilter = (activeStrategyFilter === 'ALL' || activeStrategyFilter === strategyCode);
                    }
                    
                    return passesConfidence && passesStrategyFilter; 
                }); 

                if (filteredSignals.length === 0) { signalTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-3">Filtreye uygun kurulum sinyali yok.</td></tr>`; return; } 
                
                filteredSignals.slice(0, MAX_SIGNALS).forEach(signal => { 
                    try { 
                        signalTableBody.appendChild(createMainSignalRow(signal)); 
                    } catch(e) { 
                        console.error("HATA: createMainSignalRow √ßizim hatasƒ±! Sinyal atlandƒ±:", e, signal); 
                    } 
                }); 
            } catch(e) { console.error("HATA: renderMainSignals i√ßinde:", e); }
        }

        function renderMomentumSignals() {
            try { 
                const signalsArray = Object.values(momentumSignals);
                sortSignals(signalsArray, 'timestamp', 'desc');

                momentumTableBody.innerHTML = ''; 
                if (signalsArray.length === 0) { 
                    momentumTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Hen√ºz momentum sinyali yok.</td></tr>`; 
                    return; 
                } 
                const signalsToShow = signalsArray.slice(0, MAX_SIGNALS); 
                signalsToShow.forEach(signal => { try { momentumTableBody.appendChild(createMomentumSignalRow(signal)); } catch(e) { console.error("HATA: createMomentumSignalRow i√ßinde:", e, signal); } });
            } catch(e) { console.error("HATA: renderMomentumSignals i√ßinde:", e); }
        }

        function renderWatchlist() {
            try { 
                const watchlistArray = Object.values(currentWatchlist); 
                sortSignals(watchlistArray, wlSortState.key, wlSortState.direction); 
                watchlistTableBody.innerHTML = ''; 
                if (watchlistArray.length === 0) { watchlistTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-3">Liste bo≈ü veya y√ºkleniyor...</td></tr>`; return; }
                watchlistArray.forEach(item => { 
                    try { 
                        const row = createWatchlistRow(item); 
                        if(row) watchlistTableBody.appendChild(row); 
                    } catch(e) { 
                        console.error("HATA: createWatchlistRow i√ßinde:", e, item); 
                    } 
                }); 
            } catch(e) { console.error("HATA: renderWatchlist i√ßinde:", e); }
        }

        // --- Satƒ±r Olu≈üturma Fonksiyonlarƒ± ---
        function createMainSignalRow(signal) { 
            try { 
                const row = document.createElement('tr'); 
                row.id = 'signal-' + (signal.id || Math.random()); 
                
                let signalClass = 'bg-wait';
                const shortSignal = signal.signal; 

                if (signal.signal === 'B. LONG') signalClass = 'signal-pending-long compact-signal';
                else if (signal.signal === 'B. SHORT') signalClass = 'signal-pending-short compact-signal';
                else if (signal.signal === 'ANLIK LONG') signalClass = 'bg-pump compact-signal';
                else if (signal.signal === 'ANLIK SHORT') signalClass = 'bg-dump compact-signal';
                else if (signal.isFiltered) signalClass = 'status-reddet compact-signal';
                
                const tradingViewSymbol = (signal.symbol || '').replace('USDT', '');
                const tradingViewLink = `https://www.tradingview.com/chart/?symbol=BITGET:${tradingViewSymbol}USDT.P`; 
                const strategyTag = getStrategyTag(signal.strategyType); 
                
                const confidence = signal.confidence ? `${signal.confidence}%` : '---'; 
                const volumeFormatted = getVolumeClassAndText(signal); 
                const formattedReason = formatReasonText(signal.tacticalAnalysis || signal.reason); 
                const rrValue = signal.RR && signal.RR !== 'N/A' && parseFloat(signal.RR) > 0 ? signal.RR : '---';
                const tpSlText = (signal.TP && signal.TP !== '---') ? `TP: ${signal.TP} / SL: ${signal.SL}` : '---';
                const entryPriceStyle = 'font-weight:bold; color: #ffc107;'; 

                row.innerHTML = `<td>${formatTimestamp(signal.timestamp)}</td> 
                                <td class="symbol-cell"><a href="${tradingViewLink}" target="_blank" class="link-text">${signal.symbol || 'N/A'}</a> ${strategyTag}</td> 
                                <td class="${signalClass}">${shortSignal}</td> 
                                <td style="text-align: right;">${confidence}</td> 
                                <td style="text-align: right; ${entryPriceStyle}">${signal.entryPrice || '---'}</td> 
                                <td>${tpSlText}</td> 
                                <td style="text-align: right;">${rrValue}</td> 
                                <td>${volumeFormatted}</td> 
                                <td class="reason-cell">${formattedReason || '---'}</td>`; 
                return row; 
            } catch(e) { 
                throw new Error(`Sinyal √ßizilirken hata: ${e.message}. Sinyal verisi: ${JSON.stringify(signal)}`);
            }
        }
        
        function createMomentumSignalRow(signal) { 
            try { 
                const row = document.createElement('tr'); 
                row.id = 'momentum-' + (signal.id || Math.random()); 
                const signalClass = signal.signal === 'PUMP' ? 'bg-pump compact-signal' : 'bg-dump compact-signal'; 
                
                const tradingViewSymbol = (signal.symbol || '').replace('USDT', ''); 
                const tradingViewLink = `https://www.tradingview.com/chart/?symbol=BITGET:${tradingViewSymbol}USDT.P&interval=1`; 
                
                // V46.1: D√ºzeltilmi≈ü S√ºtunlar
                row.innerHTML = `<td>${formatTimestamp(signal.timestamp)}</td> 
                                <td><a href="${tradingViewLink}" target="_blank" class="link-text">${signal.symbol || 'N/A'}</a></td> 
                                <td class="${signalClass}">${signal.signal}</td> 
                                <td style="text-align: right;">${signal.entryPrice || '---'}</td> 
                                <td class="reason-cell">${formatReasonText(signal.tacticalAnalysis) || '---'}</td>`; 
                return row; 
            } catch(e) { console.error("HATA: createMomentumSignalRow:", e, signal); return document.createElement('tr'); }
        }
        
        function createWatchlistRow(item) { 
            try { 
                const row = document.createElement('tr'); 
                row.id = `wl-${item.symbol}`; 
                
                let signalClass = item.statusClass || 'bg-wait'; 
                const shortSignal = item.signal;

                if (item.signal === 'B. LONG') signalClass = 'signal-pending-long compact-signal';
                else if (item.signal === 'B. SHORT') signalClass = 'signal-pending-short compact-signal';
                else if (item.signal === 'ANLIK LONG') signalClass = 'bg-pump compact-signal';
                else if (item.signal === 'ANLIK SHORT') signalClass = 'bg-dump compact-signal';
                else if (item.isFiltered) signalClass = 'status-reddet compact-signal';
                else if (item.signal === 'WAIT') signalClass = 'signal-beklemede compact-signal';
                
                const removeButton = `<button class="btn btn-danger btn-sm py-0 px-1" onclick="removeWatchlist('${item.symbol}')" title="Kaldƒ±r">&times;</button>`; 
                const entryPrice = item.entryPrice || '---'; 
                
                const volumeFormatted = getVolumeClassAndText(item); 
                const formattedReason = formatReasonText(item.tacticalAnalysis || item.reason); 
                const stopLabel = item.SL ? `SL: ${item.SL}` : 'SL: ---'; 
                const confidenceText = item.confidence ? `${item.confidence}%` : '---';
                const strategyTag = getStrategyTag(item.strategyType);
                
                const tradingViewSymbol = (item.symbol || '').replace('USDT', ''); 
                const tradingViewLink = `https://www.tradingview.com/chart/?symbol=BITGET:${tradingViewSymbol}USDT.P`; 
                
                const rrValue = item.RR && item.RR !== 'N/A' && parseFloat(item.RR) > 0 ? item.RR : '---';
                const tpSlText = (item.TP && item.TP !== '---') ? `TP: ${item.TP} / ${stopLabel}` : '---';
                
                const entryPriceStyle = 'font-weight:bold; color: #ffc107;';

                row.innerHTML = `<td>${formatTimestamp(item.timestamp)}</td> 
                                <td><a href="${tradingViewLink}" target="_blank" class="link-text">${item.symbol || 'N/A'}</a> ${strategyTag}</td> 
                                <td class="${signalClass}">${shortSignal}</td> 
                                <td style="text-align: right; ${entryPriceStyle}">${entryPrice}</td> 
                                <td>${tpSlText}</td> 
                                <td style="text-align: right;">${rrValue}</td> 
                                <td>${volumeFormatted}</td> 
                                <td class="reason-cell">${formattedReason || '---'} | G√ºv: ${confidenceText}</td> 
                                <td>${removeButton}</td>`; 
                return row; 
            } catch(e) { console.error("HATA: createWatchlistRow:", e, item); return null; }
        }

        function sortSignals(signalsArray, key, direction) { try { if(!signalsArray) return; signalsArray.sort((a, b) => { let aVal = a?.[key]; let bVal = b?.[key]; if (key === 'timestamp' || key === 'confidence' || key === 'RR' || key === 'currentPrice') { aVal = parseFloat(aVal) || (direction === 'asc' ? Infinity : -Infinity); bVal = parseFloat(bVal) || (direction === 'asc' ? Infinity : -Infinity); return direction === 'asc' ? aVal - bVal : bVal - aVal; } else { aVal = (aVal || '').toString().toLowerCase(); bVal = (bVal || '').toString().toLowerCase(); if (aVal < bVal) return direction === 'asc' ? -1 : 1; if (aVal > bVal) return direction === 'asc' ? 1 : -1; return 0; }}); } catch(e) { console.error("HATA: sortSignals:", e); } }

        
        // --- Olay Dinleyicileri (V46.1 UYUMLU) ---
        
        socket.on('initial_state', (state) => {
            console.log('initial_state alƒ±ndƒ± (V46.1 Uyumlu)', state);
            try {
                // V14.3.3 sunucusu state.signals (ARRAY) g√∂nderir
                const allSignalsData = state?.signals || [];
                
                // V46.1: Sunucudan gelen diziyi (global.APP_STATE.signals) V45.0'daki gibi b√∂l√º≈üt√ºr
                momentumSignals = allSignalsData.filter(s => s && s.strategyType === 'MOMENTUM1H').reduce((obj, item) => {
                    obj[item.id] = item; // ID'ye g√∂re sakla
                    return obj;
                }, {});
                
                let nonMomentumSignals = allSignalsData.filter(s => s && s.strategyType !== 'MOMENTUM1H');
                
                const priority = {'BRK4H': 3, 'BRK2H': 2, 'BRK1H': 1};
                
                allSignals = nonMomentumSignals.reduce((obj, item) => {
                    const currentPriority = priority[item.strategyType] || 0;
                    const existingSignal = obj[item.symbol];
                    const existingPriority = existingSignal ? (priority[existingSignal.strategyType] || 0) : 0;
                    
                    if (currentPriority >= existingPriority) {
                         obj[item.symbol] = item;
                    }
                    return obj;
                }, {});

                renderMainSignals();
                renderMomentumSignals();
                updateScanStatus(state?.scanStatus || { message: 'Durum bilgisi yok.', isScanning: false });
            } catch(e){ console.error("HATA: initial_state:", e); }
        });
        
        socket.on('yeni_sinyal', (sinyal) => {
            console.log('yeni_sinyal alƒ±ndƒ± (V46.1 Uyumlu):', sinyal?.id);
            try {
                if (!sinyal || !sinyal.id) return;
                
                if (sinyal.strategyType === 'MOMENTUM1H') { 
                    momentumSignals[sinyal.id] = sinyal; // ID ile ekle/g√ºncelle
                    renderMomentumSignals(); 
                } else { 
                    const priority = {'BRK4H': 3, 'BRK2H': 2, 'BRK1H': 1};
                    const currentPriority = priority[sinyal.strategyType] || 0;
                    const existingSignal = allSignals[sinyal.symbol];
                    const existingPriority = existingSignal ? (priority[existingSignal.strategyType] || 0) : 0;

                    if (currentPriority >= existingPriority) {
                        allSignals[sinyal.symbol] = sinyal;
                        renderMainSignals(); 
                    }
                }
            } catch(e){ console.error("HATA: yeni_sinyal:", e); }
        });

        socket.on('watchlist_update', (watchlist) => { 
            console.log('watchlist_update alƒ±ndƒ±'); 
            try { currentWatchlist = watchlist || {}; renderWatchlist(); } 
            catch(e){ console.error("HATA: watchlist_update:", e); }
        });
        
        socket.on('scan_status', (status) => { 
            try { updateScanStatus(status); } 
            catch(e){ console.error("HATA: scan_status:", e); } 
        });

        document.addEventListener('DOMContentLoaded', () => { 
            console.log("DOMContentLoaded"); 
            try {
                document.querySelectorAll('.main-signal-table thead th[data-sort]').forEach(header => { 
                    header.addEventListener('click', () => { 
                        try { 
                            const key = header.getAttribute('data-sort'); 
                            const currentDirection = mainSortState.key === key ? mainSortState.direction : 'desc'; 
                            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc'; 
                            document.querySelectorAll('.main-signal-table th .sort-icon').forEach(icon => icon.innerHTML = ''); 
                            const iconSpan = header.querySelector('.sort-icon'); 
                            if(iconSpan) iconSpan.innerHTML = newDirection === 'asc' ? '‚ñ≤' : '‚ñº'; 
                            mainSortState = { key: key, direction: newDirection }; 
                            renderMainSignals(); 
                        } catch(e){ console.error("HATA: Ana tablo sƒ±ralama click:", e); } 
                    }); 
                });
                
                document.querySelectorAll('.watchlist-table thead th[data-sort-wl]').forEach(header => { 
                    header.addEventListener('click', () => { 
                        try { 
                            const key = header.getAttribute('data-sort-wl'); 
                            const currentDirection = wlSortState.key === key ? wlSortState.direction : 'desc'; 
                            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc'; 
                            wlSortState = { key: key, direction: newDirection }; 
                            renderWatchlist(); 
                        } catch(e){ console.error("HATA: Watchlist sƒ±ralama click:", e); } 
                    }); 
                });
                
                document.querySelectorAll('.btn-filter').forEach(button => { 
                    button.addEventListener('click', function() { 
                        try { 
                            document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
                            this.classList.add('active'); 
                            activeStrategyFilter = this.getAttribute('data-strategy'); 
                            renderMainSignals(); 
                        } catch(e){ console.error("HATA: Strateji filtre click:", e); } 
                    }); 
                });
                
                applyFilterButton.addEventListener('click', () => { try { currentThreshold = parseInt(confidenceThresholdInput.value) || 0; renderMainSignals(); } catch(e){ console.error("HATA: G√ºven filtre uygulama click:", e); } });
                showAllButton.addEventListener('click', () => { try { currentThreshold = 0; confidenceThresholdInput.value = 0; renderMainSignals(); } catch(e){ console.error("HATA: T√ºm√ºn√º g√∂ster click:", e); } });
                
                analyzeButton.addEventListener('click', async (e) => { 
                    e.preventDefault(); 
                    try { 
                        const symbol = symbolInput.value.trim().toUpperCase();
                        if (!symbol) return; 
                        analyzeButton.disabled = true; analyzeButton.textContent = 'Analiz...'; manualResultWrapper.style.display = 'none'; 
                        const response = await fetch('/api/analyze-coin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ symbol }) }); 
                        const result = await response.json(); 
                        manualResultDiv.innerHTML = renderManualResult(result); 
                        manualResultWrapper.style.display = 'block'; 
                        if(!result.error && result.signal !== 'HATA/YOK' && result.signal !== 'WAIT') symbolInput.value = ''; 
                    } catch (err) { 
                        manualResultDiv.innerHTML = `<div class="manual-result-title" style="color:#f44336;">HATA</div><div class="manual-result-text">API isteƒüi ba≈üarƒ±sƒ±z. L√ºtfen sembol√ºn ge√ßerli ve doƒüru formatta olduƒüundan emin olun (√ñrn: BTC). Hata: ${err.message}</div>`;
                        manualResultWrapper.style.display = 'block'; 
                    } finally { 
                        analyzeButton.disabled = false; analyzeButton.textContent = 'Analiz Et & Takip Et';
                    }
                });
                
                manualCloseBtn.addEventListener('click', () => { manualResultWrapper.style.display = 'none'; });
                
                renderMainSignals(); 
                renderMomentumSignals(); 
                renderWatchlist();
            } catch(e) { console.error("HATA: DOMContentLoaded i√ßinde:", e); }
        });

        // [V46.1] G√úNCELLEMESƒ∞ 
        function renderManualResult(result) { 
            try { 
                if (!result) { return `<div class="manual-result-title" style="color:#f44336;">HATA</div><div class="manual-result-text">Ge√ßersiz yanƒ±t.</div>`; }
                if (result.error) { return `<div class="manual-result-title" style="color:#f44336;">HATA</div><div class="manual-result-text">${result.error}</div>`; } 
                
                const shortSignal = result.signal; 

                let signalClass = 'bg-wait';
                if (result.signal === 'B. LONG') signalClass = 'signal-pending-long compact-signal'; 
                else if (result.signal === 'B. SHORT') signalClass = 'signal-pending-short compact-signal';
                else if (result.signal === 'ANLIK LONG') signalClass = 'bg-pump compact-signal';
                else if (result.signal === 'ANLIK SHORT') signalClass = 'bg-dump compact-signal';
                else if (result.isFiltered) signalClass = 'status-reddet compact-signal';
                else if (result.signal === 'WAIT') signalClass = 'signal-beklemede compact-signal';
                else if (result.signal === 'HATA/YOK') signalClass = 'bg-warning text-dark compact-signal';
                
                const tradingViewSymbol = (result.symbol || '').replace('USDT', '');
                const priceLink = `<a href="https://www.tradingview.com/chart/?symbol=BITGET:${tradingViewSymbol}USDT.P" target="_blank" class="link-text" style="font-size:1.1em;">${result.symbol || 'N/A'}</a>`; 
                
                const formattedReason = formatReasonText(result.tacticalAnalysis || result.reason); 
                const stopLabel = result.SL ? `SL: ${result.SL}` : 'SL: ---'; 
                const confidenceText = result.confidence ? `${result.confidence}%` : '---'; 
                const volumeFormatted = getVolumeClassAndText(result); 
                const rrValue = result.RR && result.RR !== 'N/A' && parseFloat(result.RR) > 0 ? result.RR : '---';
                const tpSlText = (result.TP && result.TP !== '---') ? `TP: ${result.TP} / ${stopLabel}` : '---';
                const entryPriceStyle = 'font-weight:bold; color: #ffc107;';
                const entryPriceLabel = (result.strategyType && result.strategyType.includes('BRK')) ? 'Tetikleme Fiyatƒ±:' : 'Giri≈ü:';
                
                const leverageHtml = result.leverage ? `| Kaldƒ±ra√ß: ${result.leverage}` : ''; // V14'te kaldƒ±ra√ß yok


                return `<div class="manual-result-title">Manuel Analiz (${formatTimestamp(result.timestamp)})</div> 
                            <div style="margin-bottom: 10px;">${priceLink} <span class="${signalClass}">${shortSignal}</span> ${leverageHtml}</div> 
                            <div class="manual-result-text"> 
                                <p><strong>${entryPriceLabel}</strong> <span style="${entryPriceStyle}">${result.entryPrice || '---'}</span> | <strong>G√ºven:</strong> ${confidenceText}</p> 
                                <p><strong>TP/SL:</strong> ${tpSlText} | <strong>R/R: ${rrValue}</strong></p> 
                                <p><strong>Hacim:</strong> ${volumeFormatted}</p> 
                                <p><strong>A√ßƒ±klama:</strong> ${formattedReason || '---'}</p> 
                            </div>`; 
            } catch(e) { console.error("HATA: renderManualResult i√ßinde:", e, "Result:", result); return "Sonu√ß g√∂sterilirken hata olu≈ütu."; }
        }
        
        async function removeWatchlist(symbol) { 
            try { 
                const response = await fetch('/api/remove-watchlist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ symbol }) }); 
                
                if (!response.ok) {
                    const result = await response.json();
                    alert(`Hata: ${result.error || 'Bilinmeyen sunucu hatasƒ±'}`);
                }
            } catch (err) { alert(`Sunucu hatasƒ±: ${err.message}`); } 
        }
        window.removeWatchlist = removeWatchlist; 

        function updateScanStatus(status) { 
            try { 
                const statusMsg = status?.message || 'Durum bilinmiyor.';
                if(scanStatusText) scanStatusText.textContent = statusMsg; 
                if(scanSpinner) scanSpinner.style.display = status?.isScanning ? 'inline-block' : 'none'; 
                if(scanStatusText) { 
                    scanStatusText.classList.toggle('text-primary', status?.isScanning); 
                    scanStatusText.classList.toggle('fw-bold', status?.isScanning); 
                }
            } catch(e){ console.error("HATA: updateScanStatus i√ßinde:", e); } 
        }
        
        // V14.9'a uyum i√ßin global fonksiyonlar
        window.toggleTactic = toggleTactic;
        window.removeWatchlist = removeWatchlist;
        window.filterSignals = filterSignals;

    </script>
</body>
</html>