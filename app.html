<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonny AI Trader v25.1 - Cockpit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #05070D;
            --bg-card: #101522;
            --bg-hover: #1A2235;
            --bg-overlay: rgba(16, 21, 34, 0.85);
            --accent-blue: #00BFFF;
            --accent-blue-hover: #0099CC;
            --accent-green: #00FFAA;
            --accent-red: #FF4D4D;
            --accent-yellow: #F59E0B;
            --accent-purple: #9370DB;
            --text-primary: #FFFFFF;
            --text-secondary: #B0C4DE;
            --text-muted: #708090;
            --border-light: rgba(173, 216, 230, 0.15);
            --shadow-deep: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            position: sticky; top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(28, 35, 51, 0.85);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1800px; margin: 0 auto; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background: var(--accent-blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .logo-text { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
        .version { background: var(--accent-blue); color: var(--bg-dark); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; margin-left: 8px; }
        .container { max-width: 1800px; margin: 0 auto; padding: 1.5rem 2rem; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            border: 1px solid var(--border-light);
            border-left: 4px solid var(--accent-blue);
            transition: all 0.3s ease;
        }
        .metric-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .metric-label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1.75rem; font-weight: 700; margin-top: 0.25rem; }
        .metric-positive { color: var(--accent-green); }
        .metric-negative { color: var(--accent-red); }
        .metric-neutral { color: var(--text-primary); }
        .control-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .control-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .control-buttons { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .filter-bar { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; }
        .filter-select, .filter-input { background: var(--bg-dark); border: 1px solid var(--border-light); border-radius: 6px; padding: 0.4rem 0.8rem; color: var(--text-primary); font-size: 0.85rem; }
        .filter-select:focus, .filter-input:focus { outline: none; border-color: var(--accent-blue); }
        .table-container { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 12px; overflow-x: auto; margin-bottom: 1.5rem; }
        .table-header { background: var(--bg-hover); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-light); }
        .table-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: var(--bg-hover); padding: 0.8rem 1.25rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-light); }
        td { padding: 0.9rem 1.25rem; border-bottom: 1px solid var(--border-light); font-size: 0.9rem; vertical-align: middle; }
        tbody tr[onclick] { transition: background-color 0.2s ease; }
        tbody tr[onclick]:hover { background: var(--bg-hover); cursor: pointer; }
        tbody tr:last-child td { border-bottom: none; }
        .direction-long { color: var(--accent-green); font-weight: 600; }
        .direction-short { color: var(--accent-red); font-weight: 600; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:disabled { background-color: var(--text-muted) !important; color: var(--bg-card) !important; cursor: not-allowed !important; opacity: 0.5; }
        .btn-primary { background: var(--accent-blue); color: var(--bg-dark); font-weight: 700; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-blue-hover); }
        .btn-success { background: var(--accent-green); color: #000; }
        .btn-success:hover:not(:disabled) { background: #00cc88; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #ff2a2a; }
        .btn-outline { background: transparent; border: 1px solid var(--border-light); color: var(--text-secondary); }
        .btn-outline:hover:not(:disabled) { border-color: var(--accent-blue); color: var(--accent-blue); }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .status-online { color: var(--accent-green); }
        .status-offline { color: var(--accent-red); }
        .confidence-bar { width: 70px; height: 5px; background: var(--bg-hover); border-radius: 3px; overflow: hidden; }
        .confidence-fill { height: 100%; border-radius: 3px; }
        .connection-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-connected { background: rgba(0, 255, 170, 0.1); color: var(--accent-green); border: 1px solid rgba(0, 255, 170, 0.2); }
        .status-disconnected { background: rgba(255, 77, 77, 0.1); color: var(--accent-red); border: 1px solid rgba(255, 77, 77, 0.2); }
        .ai-badge { background: var(--accent-blue); color: var(--bg-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .profit-badge { background: rgba(0, 255, 170, 0.1); color: var(--accent-green); padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .loss-badge { background: rgba(255, 77, 77, 0.1); color: var(--accent-red); padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .strategy-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        .mrv-badge { background: var(--accent-purple); color: white; }
        .momentum-badge { background: var(--accent-yellow); color: var(--bg-dark); }
        .signal-label { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; }
        .signal-label strong { color: var(--text-primary); font-weight: 600; }
        .signal-subtext { font-size: 0.75rem; color: var(--text-muted); }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
            z-index: 10000; padding: 1rem; overflow-y: auto;
        }
        .modal-content {
            background: var(--bg-card); border-radius: 12px; padding: 2rem;
            width: 100%; max-width: 600px; max-height: 90vh;
            overflow-y: auto; border: 1px solid var(--border-light);
            box-shadow: var(--shadow-deep);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; line-height: 1; }
        .settings-section { background: var(--bg-dark); padding: 1.25rem; border-radius: 8px; margin: 1rem 0; }
        .settings-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .setting-item { display: flex; flex-direction: column; gap: 0.5rem; }
        .setting-label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; }
        .setting-input { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 6px; padding: 0.6rem; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .setting-input:focus { outline: none; border-color: var(--accent-blue); }
        #signalModalBody { display: flex; flex-direction: column; gap: 0.5rem; }
        #signalModalBody div { font-size: 0.9rem; padding: 0.6rem; border-bottom: 1px solid var(--border-light); }
        #signalModalBody div:last-child { border-bottom: none; }
        #signalModalBody strong { color: var(--text-secondary); min-width: 100px; display: inline-block; font-weight: 500; }
        #signalModalBody span { color: var(--text-primary); font-weight: 600; }
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .container { padding: 1rem; }
            .header-content { flex-direction: column; gap: 0.5rem; }
            .metrics-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .metric-card { padding: 1rem; }
            .metric-value { font-size: 1.4rem; }
            .control-row { flex-direction: column; align-items: stretch; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .modal-content { padding: 1rem; margin: 0.5rem; }
            .settings-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="logo-text">
                    Sonny AI Trader <span class="version">v25.1</span>
                </div>
            </div>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-circle"></i>
                <span>Baƒülanƒ±yor...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Toplam Bakiye</div>
                <div class="metric-value metric-neutral" id="metricEquity">$---</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Kullanƒ±labilir</div>
                <div class="metric-value metric-neutral" id="metricAvailable">$---</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">A√ßƒ±k PNL</div>
                <div class="metric-value" id="metricPnl">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">G√ºnl√ºk K/Z</div>
                <div class="metric-value" id="metricDailyPL">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">G√ºnl√ºk ƒ∞≈ülem</div>
                <div class="metric-value metric-neutral" id="metricDailyTrades">0</div>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-row">
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="openRiskSettings()">
                        <i class="fas fa-sliders-h"></i>
                        Risk Ayarlarƒ±
                    </button>
                    <button class="btn btn-success" id="autoMomentumBtn" onclick="toggleAutoMomentum()">
                        <i class="fas fa-play"></i>
                        Oto-Momentum: KAPALI
                    </button>
                    <button class="btn btn-success" id="autoMrvBtn" onclick="toggleAutoMrv()">
                        <i class="fas fa-play"></i>
                        Oto-MRV: KAPALI
                    </button>
                    <button class="btn btn-outline" onclick="fetchData()">
                        <i class="fas fa-sync-alt"></i>
                        Pozisyonlarƒ± Yenile
                    </button>
                </div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Min. Kalite:</span>
                        <input type="number" id="confidenceFilter" class="filter-input" value="30" min="0" max="90" style="width: 70px;">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Strateji:</span>
                        <select id="strategyFilter" class="filter-select">
                            <option value="ALL">T√ºm√º</option>
                            <option value="MRV">Motor B (MRV)</option>
                            <option value="MOMENTUM">Motor C (Momentum)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Y√∂n:</span>
                        <select id="directionFilter" class="filter-select">
                            <option value="ALL">T√ºm√º</option>
                            <option value="LONG">LONG</option>
                            <option value="SHORT">SHORT</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-chart-line"></i>
                    A√ßƒ±k ML Pozisyonlarƒ±
                    <span class="ai-badge" id="positionsCount" style="background: var(--bg-dark); border: 1px solid var(--border-light);">0</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sembol</th>
                        <th>Y√∂n</th>
                        <th>ML Strateji</th>
                        <th>Giri≈ü Fiyatƒ±</th>
                        <th>Anlƒ±k Fiyat</th>
                        <th>Kar/Zarar</th>
                        <th>Kaldƒ±ra√ß</th>
                        <th>S√ºre</th>
                        <th>Breakeven</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="positionsBody">
                    <tr><td colspan="10" style="text-align: center; color: var(--text-muted); padding: 2rem;"><i class="fas fa-box-open" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>Aktif ML pozisyonu bulunmuyor</td></tr>
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-bolt"></i>
                    MOTOR C (Momentum) Sinyalleri
                    <span class="ai-badge" id="momentumSignalsCount" style="background: var(--accent-yellow); color: var(--bg-dark);">0</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Y√∂n</th>
                        <th>Strateji</th>
                        <th>Kalite</th>
                        <th>Giri≈ü</th>
                        <th>TP1 / SL</th>
                        <th>Kar/Risk</th>
                        <th>ML Analiz / √ñng√∂r√º</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="momentumSignalsBody">
                    <tr><td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">Motor C (Momentum) taranƒ±yor...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-drafting-compass"></i>
                    MOTOR B (Mean Reversion) Sinyalleri
                    <span class="ai-badge" id="breakoutSignalsCount" style="background: var(--accent-purple);">0</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Y√∂n</th>
                        <th>Strateji</th>
                        <th>Kalite</th>
                        <th>Giri≈ü</th>
                        <th>TP1 / SL</th>
                        <th>Kar/Risk</th>
                        <th>ML Analiz / √ñng√∂r√º</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="breakoutSignalsBody">
                    <tr><td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">Motor B (Mean Reversion) taranƒ±yor...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div class="modal-backdrop" id="signalModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="signalModalTitle">Sinyal Detayƒ±</div>
                <button class="close-btn" onclick="closeSignalModal()">&times;</button>
            </div>
            <div id="signalModalBody"></div>
        </div>
    </div>

    <div id="modal-placeholder"></div>

    <script>
        // ==========================================================
        // Sonny AI Trader v25.1 - Aray√ºz JavaScript (Patched)
        // G√ºvenli parsing, data-signal, ws guard, safe formatting
        // ==========================================================

        let allMomentumSignals = [];
        let allBreakoutSignals = [];
        let openPositions = [];
        let currentConfig = {};
        let wsConnection = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sonny AI Trader v25.1 (Cyber Cockpit) - Aray√ºz ba≈ülatƒ±lƒ±yor...');
            initializeApp();
        });

        async function initializeApp() {
            await connectWebSocket();
            await fetchData();
            setInterval(fetchData, 7000);
            document.getElementById('confidenceFilter').addEventListener('change', renderAllSignalTables);
            document.getElementById('directionFilter').addEventListener('change', renderAllSignalTables);
            document.getElementById('strategyFilter').addEventListener('change', renderAllSignalTables);
        }

        async function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = protocol + '//' + window.location.host;
                console.log(`üîó ML WebSocket baƒülantƒ±sƒ± kuruluyor: ${wsUrl}`);

                wsConnection = new WebSocket(wsUrl);

                wsConnection.onopen = () => {
                    console.log('‚úÖ ML WebSocket baƒülantƒ±sƒ± kuruldu');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                };

                wsConnection.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data || '{}');
                        if (!data || !data.type || !Array.isArray(data.data)) {
                            console.warn('WS: Beklenmeyen mesaj formatƒ±', data);
                            return;
                        }
                        if (data.type === 'momentum_signals') {
                            allMomentumSignals = Array.isArray(data.data) ? data.data : [];
                            renderMomentumSignals(allMomentumSignals);
                        } else if (data.type === 'breakout_signals') {
                            allBreakoutSignals = Array.isArray(data.data) ? data.data : [];
                            renderBreakoutSignals(allBreakoutSignals);
                        }
                    } catch (error) { console.error('‚ùå ML WebSocket mesaj parse hatasƒ±:', error); }
                };

                wsConnection.onclose = (event) => {
                    console.log('‚ùå ML WebSocket baƒülantƒ±sƒ± kesildi:', event.code, event.reason);
                    updateConnectionStatus(false);
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 10000);
                        console.log(`üîÑ ${reconnectAttempts}. yeniden baƒülanma denemesi (${delay}ms sonra)`);
                        setTimeout(connectWebSocket, delay);
                    } else { console.error('‚ùå Maksimum yeniden baƒülanma denemesi a≈üƒ±ldƒ±'); }
                };

                wsConnection.onerror = (error) => {
                    console.error('‚ùå ML WebSocket hatasƒ±:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('‚ùå ML WebSocket baƒülantƒ± hatasƒ±:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-circle status-online"></i><span>Baƒülƒ±</span>';
                statusElement.className = 'connection-status status-connected';
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle status-offline"></i><span>Baƒülantƒ± Kesildi</span>';
                statusElement.className = 'connection-status status-disconnected';
            }
        }

        async function fetchData() {
            try {
                const [metricsRes, configRes] = await Promise.all([
                    fetch('/api/metrics'),
                    fetch('/api/config/status')
                ]);
                if (!metricsRes.ok) throw new Error(`Metrik API hatasƒ±: ${metricsRes.status}`);
                if (!configRes.ok) throw new Error(`Config API hatasƒ±: ${configRes.status}`);

                const metrics = await metricsRes.json();
                const status = await configRes.json();

                currentConfig = status || {};
                // safe fallback: server may not return full openPositions list
                openPositions = status.openPositions || [];

                updateMetrics(metrics);
                updateAutoMomentumButton(status.autoTradeMomentum);
                updateAutoMrvButton(status.autoTradeMeanReversion);
                updatePositionsTable();

            } catch (error) {
                console.error('‚ùå Veri √ßekme hatasƒ±:', error.message);
                updateConnectionStatus(false);
            }
        }

        // Safe format helpers
        function fmtMoney(v) { return (typeof v === 'number' && isFinite(v)) ? `$${v.toFixed(2)}` : '$0.00'; }
        function safeNum(v, digits = 6) { return (typeof v === 'number' && isFinite(v)) ? v.toFixed(digits) : '---'; }
        function safeTwo(v) { return (typeof v === 'number' && isFinite(v)) ? v.toFixed(2) : '--'; }
        function safeTime(ts) { const t = Number(ts); return Number.isFinite(t) ? new Date(t).toLocaleTimeString('tr-TR') : '--:--'; }

        function updateMetrics(metrics) {
            document.getElementById('metricEquity').textContent = fmtMoney(metrics?.totalEquity);
            document.getElementById('metricAvailable').textContent = fmtMoney(metrics?.availableMargin);

            const pnlValue = (typeof metrics?.unrealizedPnl === 'number') ? metrics.unrealizedPnl : 0;
            document.getElementById('metricPnl').textContent = `$${pnlValue.toFixed(2)}`;
            document.getElementById('metricPnl').className = `metric-value ${pnlValue >= 0 ? 'metric-positive' : 'metric-negative'}`;

            const dailyPlValue = (typeof metrics?.dailyPL === 'number') ? metrics.dailyPL : 0;
            document.getElementById('metricDailyPL').textContent = `$${dailyPlValue.toFixed(2)}`;
            document.getElementById('metricDailyPL').className = `metric-value ${dailyPlValue >= 0 ? 'metric-positive' : 'metric-negative'}`;

            document.getElementById('metricDailyTrades').textContent = metrics?.dailyTrades || 0;
        }

        function renderAllSignalTables() {
            renderMomentumSignals(allMomentumSignals);
            renderBreakoutSignals(allBreakoutSignals);
        }

        function renderMomentumSignals(signals) {
            const tbody = document.getElementById('momentumSignalsBody');
            const signalsCount = document.getElementById('momentumSignalsCount');
            if (!tbody || !signalsCount) return;

            const momentumOnlySignals = (signals || []).filter(s => s && s.isMomentumSignal);
            signalsCount.textContent = momentumOnlySignals.length;

            if (momentumOnlySignals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">Motor C (Momentum) taranƒ±yor...</td></tr>`;
                return;
            }

            const filteredSignals = filterSignals(momentumOnlySignals, 'MOMENTUM');
            if (filteredSignals.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">Filtrelere uyan Momentum sinyali yok.</td></tr>`;
                 return;
            }

            tbody.innerHTML = filteredSignals.map(signal => generateSignalRowHtml(signal)).join('');
        }

        function renderBreakoutSignals(signals) {
            const tbody = document.getElementById('breakoutSignalsBody');
            const signalsCount = document.getElementById('breakoutSignalsCount');
            if (!tbody || !signalsCount) return;

            signals = signals || [];
            signalsCount.textContent = signals.length;

            if (signals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">Motor B (Mean Reversion) taranƒ±yor...</td></tr>`;
                return;
            }

            const filteredSignals = filterSignals(signals, 'MRV');
            if (filteredSignals.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">Filtrelere uyan Mean Reversion sinyali yok.</td></tr>`;
                 return;
            }

            tbody.innerHTML = filteredSignals.map(signal => generateSignalRowHtml(signal)).join('');
        }

        function filterSignals(signals, strategyType) {
            const minConfidence = parseInt(document.getElementById('confidenceFilter').value) || 0;
            const directionFilter = document.getElementById('directionFilter').value;
            const strategyFilter = document.getElementById('strategyFilter').value;

            return signals.filter(signal => {
                const confidenceMatch = (signal.confidence || 0) >= minConfidence;
                const directionMatch = directionFilter === 'ALL' || (signal.taraf || 'LONG') === directionFilter;

                let strategyMatch = true;
                if (strategyFilter === 'MRV') strategyMatch = signal.isBreakoutSignal === true;
                else if (strategyFilter === 'MOMENTUM') strategyMatch = signal.isMomentumSignal === true;

                let typeMatch = false;
                if (strategyType === 'MOMENTUM' && signal.isMomentumSignal) typeMatch = true;
                if (strategyType === 'MRV' && signal.isBreakoutSignal) typeMatch = true;

                return confidenceMatch && directionMatch && strategyMatch && typeMatch;
            });
        }

        // Safe encode/decode for embedding signal object in DOM attributes
        function encodeSignal(signal) {
            try { return encodeURIComponent(JSON.stringify(signal)); }
            catch (e) { return ''; }
        }
        function decodeSignal(encoded) {
            try { return JSON.parse(decodeURIComponent(encoded)); }
            catch (e) { console.error('Signal decode error', e); return null; }
        }

        // generateSignalRowHtml - fixed: data-signal, safe formatting, safe onclick usage
        function generateSignalRowHtml(signal) {
            let strategyBadge = '';
            let strategyText = '';

            if (signal.isBreakoutSignal) {
                strategyBadge = 'mrv-badge';
                strategyText = `MOTOR B (${signal.tip || 'MRV'})`;
            } else if (signal.isMomentumSignal) {
                strategyBadge = 'momentum-badge';
                strategyText = `MOTOR C (${signal.tip || 'MOMENTUM'})`;
            }

            const tp1 = typeof signal.tp1 === 'number' ? signal.tp1.toFixed(6) : (signal.tp1 ? String(signal.tp1) : '---');
            const sl = typeof signal.sl === 'number' ? signal.sl.toFixed(6) : (signal.sl ? String(signal.sl) : '---');
            const profitPercent1 = (typeof signal.profitPercent1 === 'number') ? signal.profitPercent1.toFixed(2) : '--';
            const riskPercent = (typeof signal.riskPercent === 'number') ? signal.riskPercent.toFixed(2) : '--';
            const riskReward = (signal.riskReward !== undefined && signal.riskReward !== null) ? signal.riskReward : '?';
            const timeStr = safeTime(signal.timestamp);

            let ongoruHtml = '';
            if (signal.ongoru) {
                ongoruHtml = `<span class="signal-label" style="color: var(--accent-yellow);">${signal.ongoru}</span>`;
            } else if (signal.isBreakoutSignal && typeof signal.squeezeRatio === 'number') {
                ongoruHtml = `<span class="signal-label" style="color: var(--accent-purple);">Sƒ±kƒ±≈üma: %${signal.squeezeRatio.toFixed(2)}</span>`;
            }

            const hacimLabel = `Hacim: <strong style="color: ${getLabelColor(signal.hacim_durumu)}">${signal.hacim_durumu || '?'}</strong>`;
            const analizLabel = signal.hacim_analizi || '';

            const safeSignalAttr = encodeSignal(signal);

            // tr data-signal + onclick calls openSignalModalFromRow(this)
            return `
            <tr data-signal="${safeSignalAttr}" onclick="openSignalModalFromRow(this)">
                <td>
                    <strong>${signal.coin || 'N/A'}</strong>
                    <div class="signal-subtext">${timeStr}</div>
                    <a href="${signal.tv_link || '#'}" target="_blank" class="signal-subtext" style="color: var(--accent-blue); text-decoration: none;" onclick="event.stopPropagation();"><i class="fas fa-external-link-alt"></i> Chart</a>
                </td>
                <td><span class="${(signal.taraf || 'LONG') === 'LONG' ? 'direction-long' : 'direction-short'}">${signal.taraf || 'LONG'}</span></td>
                <td><span class="strategy-badge ${strategyBadge}">${strategyText}</span></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-weight: 600; color: ${getConfidenceColor(signal.confidence)}">${signal.confidence || 0}%</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width:${signal.confidence || 0}%; background: ${getConfidenceColor(signal.confidence)}"></div>
                        </div>
                    </div>
                </td>
                <td><strong>${(typeof signal.giris === 'number') ? signal.giris.toFixed(6) : (signal.giris ? String(signal.giris) : '---')}</strong></td>
                <td>
                    <div class="signal-label">
                        <div style="color: var(--accent-green);"><strong>TP1:</strong> ${tp1}</div>
                        <div style="color: var(--accent-red);"><strong>SL:</strong> ${sl}</div>
                    </div>
                </td>
                <td>
                    <div class="signal-label">
                        <div style="color: var(--accent-green);"><strong>K√¢r:</strong> +%${profitPercent1}</div>
                        <div style="color: var(--accent-red);"><strong>Risk:</strong> -%${riskPercent}</div>
                        <div style="color: var(--text-secondary); margin-top: 2px;"><strong>R/R: ${riskReward}</strong></div>
                    </div>
                </td>
                <td>
                    <div class="signal-label" style="max-width: 200px; line-height: 1.4;">
                        ${ongoruHtml}
                        <div style="margin-top: 4px;">
                            ${hacimLabel} <br> ${analizLabel}
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn btn-success btn-small" data-signal="${safeSignalAttr}" onclick="event.stopPropagation(); onClickExecuteTrade(this)" ${openPositions.length >= (currentConfig.maxPositions || 5) ? 'disabled' : ''}>
                        <i class="fas fa-play"></i>
                        A√ß
                    </button>
                </td>
            </tr>
            `;
        }

        // Handlers for row/button actions (safe)
        function openSignalModalFromRow(tr) {
            try {
                const encoded = tr.getAttribute('data-signal');
                const signal = decodeSignal(encoded);
                if (!signal) return;
                openSignalModal(signal);
            } catch (err) { console.error('Row sinyal parse hatasƒ±', err); }
        }

        function onClickExecuteTrade(btn) {
            try {
                const encoded = btn.getAttribute('data-signal');
                if (!encoded) return alert('Sinyal verisi eksik');
                const signal = decodeSignal(encoded);
                if (!signal) return alert('Sinyal verisi okunamadƒ±');
                executeTrade(btn, signal);
            } catch (err) { console.error('Sinyal parse hatasƒ±:', err); alert('Sinyal verisi okunamadƒ±'); }
        }

        function updatePositionsTable() {
            const tbody = document.getElementById('positionsBody');
            const positionsCount = document.getElementById('positionsCount');

            if (!Array.isArray(openPositions) || openPositions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-box-open" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>Aktif ML pozisyonu bulunmuyor</td></tr>`;
                positionsCount.textContent = '0';
                return;
            }

            positionsCount.textContent = openPositions.length;
            tbody.innerHTML = openPositions.map(position => {
                const pnlClass = (position.unrealizedPnl || 0) >= 0 ? 'profit-badge' : 'loss-badge';
                const pnlSign = (position.unrealizedPnl || 0) >= 0 ? '+' : '';
                const duration = position.timestamp ? Math.round((Date.now() - position.timestamp) / 60000) : 0;
                const breakevenStatus = position.hasHitTP1 ? '‚úÖ Aktif' : '‚è≥ Bekliyor';

                let strategyBadge = '';
                let strategyText = '';

                if (position.signal?.isBreakoutSignal) {
                    strategyBadge = 'mrv-badge';
                    strategyText = `MOTOR B (MRV ${position.signal?.strategy || ''})`;
                } else if (position.signal?.isMomentumSignal) {
                    strategyBadge = 'momentum-badge';
                    strategyText = 'MOTOR C (MOMENTUM)';
                } else {
                     strategyBadge = 'ai-badge';
                     strategyText = 'MANUEL/Bƒ∞Lƒ∞NMƒ∞YOR';
                }

                return `
                <tr>
                    <td><strong>${position.symbol || 'N/A'}</strong></td>
                    <td><span class="${(position.side || 'long') === 'long' ? 'direction-long' : 'direction-short'}">${(position.side || 'long').toUpperCase()}</span></td>
                    <td><span class="strategy-badge ${strategyBadge}">${strategyText}</span></td>
                    <td>${position.entryPrice ? Number(position.entryPrice).toFixed(6) : '---'}</td>
                    <td>${position.markPrice ? Number(position.markPrice).toFixed(6) : '---'}</td>
                    <td><span class="${pnlClass}">${pnlSign}$${Number(position.unrealizedPnl || 0).toFixed(2)}</span></td>
                    <td>${position.leverage || 5}x</td>
                    <td>${duration}dk</td>
                    <td><span style="font-size: 0.8rem; color: ${position.hasHitTP1 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${breakevenStatus}</span></td>
                    <td><button class="btn btn-danger btn-small" onclick="closePosition(this, '${position.symbol}')"><i class="fas fa-stop"></i> Kapat</button></td>
                </tr>
                `;
            }).join('');
        }

        // Utility functions
        function getConfidenceColor(confidence) {
            confidence = confidence || 0;
            if (confidence >= 80) return 'var(--accent-green)';
            if (confidence >= 50) return 'var(--accent-yellow)';
            return 'var(--accent-red)';
        }
        function getLabelColor(label) {
            if (label === 'Y√úKSEK') return 'var(--accent-green)';
            if (label === 'ORTA') return 'var(--accent-yellow)';
            if (label === 'NORMAL') return 'var(--text-secondary)';
            if (label === 'D√ú≈û√úK') return 'var(--accent-red)';
            return 'var(--text-muted)';
        }

        function refreshData() {
            console.log('üîÑ Manuel yenileme ba≈ülatƒ±ldƒ±');
            fetchData();
            if (wsConnection) wsConnection.close();
        }

        async function executeTrade(button, signal) {
            if (openPositions.length >= (currentConfig.maxPositions || 5)) {
                alert('‚ùå Maksimum pozisyon sayƒ±sƒ±na ula≈üƒ±ldƒ±!'); return;
            }

            if (!confirm(`ü§ñ ${signal.coin} ${signal.taraf} ML i≈ülemini a√ßmak istediƒüinize emin misiniz?\n\nStrateji: ${signal.tip}\nG√ºven: ${signal.confidence}%\nSabit SL: %${signal.riskPercent || '?'}`)) {
                return;
            }

            button.textContent = 'A√ßƒ±lƒ±yor...';
            button.disabled = true;

            try {
                const response = await fetch('/api/autotrade/manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signal)
                });
                const result = await response.json();
                if (result.success) {
                    button.textContent = 'A√ßƒ±ldƒ±!';
                    button.className = 'btn btn-primary btn-small';
                    await fetchData();
                } else {
                    button.textContent = 'Hata!';
                    button.className = 'btn btn-danger btn-small';
                    alert(`‚ùå Hata: ${result.message}`);
                    button.disabled = false;
                }
            } catch (error) {
                button.textContent = 'Hata!';
                button.className = 'btn btn-danger btn-small';
                alert(`‚ùå ML ƒ∞≈ülem hatasƒ±: ${error.message}`);
                button.disabled = false;
            }
        }

        async function closePosition(button, symbol) {
            if (!confirm(`‚ö†Ô∏è ${symbol} ML pozisyonunu kapatmak istediƒüinize emin misiniz?`)) {
                return;
            }
            button.textContent = 'Kapatƒ±lƒ±yor...';
            button.disabled = true;

            try {
                const response = await fetch('/api/force-remove-position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                const result = await response.json();
                if (result.success) {
                    button.textContent = 'Kapatƒ±ldƒ±!';
                    await fetchData();
                } else {
                    alert(`‚ùå Hata: ${result.message}`);
                    button.disabled = false;
                    button.textContent = 'Kapat';
                }
            } catch (error) {
                alert(`‚ùå ML Kapatma hatasƒ±: ${error.message}`);
                button.disabled = false;
                button.textContent = 'Kapat';
            }
        }

        async function toggleAutoMomentum() {
            const newState = !(currentConfig.autoTradeMomentum || false);
            const button = document.getElementById('autoMomentumBtn');
            button.disabled = true;

            try {
                const response = await fetch('/api/config/update', {
                       method: 'POST',
                       headers: { 'Content-Type': 'application/json' },
                       body: JSON.stringify({ autoTradeMomentum: newState })
                });
                const result = await response.json();
                if (result.success) {
                    currentConfig.autoTradeMomentum = newState;
                    updateAutoMomentumButton(newState);
                    alert(`‚úÖ Otomatik MOMENTUM modu ${newState ? 'AKTƒ∞F' : 'PASƒ∞F'}!`);
                } else {
                    alert('‚ùå Otomatik mod deƒüi≈ütirilemedi!');
                }
            } catch (error) {
                alert('‚ùå Sunucu hatasƒ±: ' + error.message);
            }
            button.disabled = false;
        }

        async function toggleAutoMrv() {
            const newState = !(currentConfig.autoTradeMeanReversion || false);
            const button = document.getElementById('autoMrvBtn');
            button.disabled = true;
            try {
                const response = await fetch('/api/config/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ autoTradeMeanReversion: newState })
                });
                const result = await response.json();
                if (result.success) {
                    currentConfig.autoTradeMeanReversion = newState;
                    updateAutoMrvButton(newState);
                    alert(`‚úÖ Otomatik MRV modu ${newState ? 'AKTƒ∞F' : 'PASƒ∞F'}!`);
                } else {
                    alert('‚ùå Otomatik MRV mod deƒüi≈ütirilemedi!');
                }
            } catch (error) {
                alert('‚ùå Sunucu hatasƒ±: ' + error.message);
            }
            button.disabled = false;
        }

        function updateAutoMomentumButton(isEnabled) {
            const button = document.getElementById('autoMomentumBtn');
            if (!button) return;
            if (isEnabled) {
                button.innerHTML = '<i class="fas fa-stop"></i> Oto-Momentum: A√áIK';
                button.className = 'btn btn-danger';
                currentConfig.autoTradeMomentum = true;
            } else {
                button.innerHTML = '<i class="fas fa-play"></i> Oto-Momentum: KAPALI';
                button.className = 'btn btn-success';
                currentConfig.autoTradeMomentum = false;
            }
        }

        function updateAutoMrvButton(isEnabled) {
            const button = document.getElementById('autoMrvBtn');
            if (!button) return;
            if (isEnabled) {
                button.innerHTML = '<i class="fas fa-stop"></i> Oto-MRV: A√áIK';
                button.className = 'btn btn-danger';
                currentConfig.autoTradeMeanReversion = true;
            } else {
                button.innerHTML = '<i class="fas fa-play"></i> Oto-MRV: KAPALI';
                button.className = 'btn btn-success';
                currentConfig.autoTradeMeanReversion = false;
            }
        }

        // Settings modal (uses currentConfig safely)
        function openRiskSettings() {
            const modalPlaceholder = document.getElementById('modal-placeholder');

            const {
                leverage = 10,
                marginPercent = 3,
                fixedStopLossPercent = 1.0,
                maxPositions = 3,
                momentum_min_confidence = 75,
                autoTradeMomentumVolumeLevel = 'Y√úKSEK',
                breakout_min_confidence = 50,
                orderbook_min_24h_explosion = 10,
                orderbook_imbalance_ratio = 2.5,
                orderbook_min_usd_wall = 10000,
                orderbook_signal_cooldown = 300,
                scanBatchSize = 8,
                hotCoinScanInterval = 10000,
                maxHotCoins = 10
            } = currentConfig || {};

            const modalHtml = `
                <div class="modal-backdrop" id="settings-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title"><i class="fas fa-sliders-h"></i> ML & Risk Ayarlarƒ± (v24)</div>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">‚öôÔ∏è Ana Risk Ayarlarƒ±</div>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label class="setting-label">Kaldƒ±ra√ß</label>
                                    <input type="number" id="modal_leverage" class="setting-input" value="${leverage}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Marjin (%) (Bakiye)</label>
                                    <input type="number" id="modal_marginPercent" class="setting-input" value="${marginPercent}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Sabit Stop Loss (%)</label>
                                    <input type="number" id="modal_fixedStopLossPercent" class="setting-input" value="${fixedStopLossPercent}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Maks. Pozisyon</label>
                                    <input type="number" id="modal_maxPositions" class="setting-input" value="${maxPositions}">
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">‚ö° MOTOR C (Momentum) Filtreleri</div>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label class="setting-label">Min. Kalite (%)</label>
                                    <input type="number" id="modal_momentum_min_confidence" class="setting-input" value="${momentum_min_confidence}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Min. Hacim (Oto-Trade)</label>
                                    <select id="modal_autoTradeMomentumVolumeLevel" class="setting-input">
                                        <option value="D√ú≈û√úK" ${autoTradeMomentumVolumeLevel === 'D√ú≈û√úK' ? 'selected' : ''}>D√ú≈û√úK</option>
                                        <option value="ORTA" ${autoTradeMomentumVolumeLevel === 'ORTA' ? 'selected' : ''}>ORTA</option>
                                        <option value="Y√úKSEK" ${autoTradeMomentumVolumeLevel === 'Y√úKSEK' ? 'selected' : ''}>Y√úKSEK</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Duvar Dengesizliƒüi (x)</label>
                                    <input type="number" id="modal_orderbook_imbalance_ratio" class="setting-input" value="${orderbook_imbalance_ratio}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Min. Duvar ($)</label>
                                    <input type="number" id="modal_orderbook_min_usd_wall" class="setting-input" value="${orderbook_min_usd_wall}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Sinyal Cooldown (sn)</label>
                                    <input type="number" id="modal_orderbook_signal_cooldown" class="setting-input" value="${orderbook_signal_cooldown}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Patlama E≈üiƒüi (%) (G√∂zc√º)</label>
                                    <input type="number" id="modal_orderbook_min_24h_explosion" class="setting-input" value="${orderbook_min_24h_explosion}">
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">üéØ MOTOR B (Mean Reversion) Filtreleri</div>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label class="setting-label">Min. Kalite (%)</label>
                                    <input type="number" id="modal_breakout_min_confidence" class="setting-input" value="${breakout_min_confidence}">
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">üöÄ Performans Ayarlarƒ±</div>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label class="setting-label">Tarama Batch Boyutu</label>
                                    <input type="number" id="modal_scanBatchSize" class="setting-input" value="${scanBatchSize}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Hot Coin Tarama (ms)</label>
                                    <input type="number" id="modal_hotCoinScanInterval" class="setting-input" value="${hotCoinScanInterval}">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Maks. Hot Coin</label>
                                    <input type="number" id="modal_maxHotCoins" class="setting-input" value="${maxHotCoins}">
                                </div>
                            </div>
                        </div>

                        <div style="display:flex;gap:1rem;margin-top:2rem;">
                            <button class="btn btn-primary" id="modal-save-btn" onclick="saveMLSettings(this)" style="flex:1;"><i class="fas fa-save"></i> Kaydet</button>
                            <button class="btn btn-outline" onclick="closeModal()" style="flex:1;"><i class="fas fa-times"></i> ƒ∞ptal</button>
                        </div>
                    </div>
                </div>
            `;
            modalPlaceholder.innerHTML = modalHtml;
        }

        async function saveMLSettings(button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

            const settings = {
                leverage: parseFloat(document.getElementById('modal_leverage').value),
                marginPercent: parseFloat(document.getElementById('modal_marginPercent').value),
                fixedStopLossPercent: parseFloat(document.getElementById('modal_fixedStopLossPercent').value),
                maxPositions: parseInt(document.getElementById('modal_maxPositions').value),
                momentum_min_confidence: parseInt(document.getElementById('modal_momentum_min_confidence').value),
                autoTradeMomentumVolumeLevel: document.getElementById('modal_autoTradeMomentumVolumeLevel').value,
                orderbook_imbalance_ratio: parseFloat(document.getElementById('modal_orderbook_imbalance_ratio').value),
                orderbook_min_usd_wall: parseInt(document.getElementById('modal_orderbook_min_usd_wall').value),
                orderbook_signal_cooldown: parseInt(document.getElementById('modal_orderbook_signal_cooldown').value),
                orderbook_min_24h_explosion: parseFloat(document.getElementById('modal_orderbook_min_24h_explosion').value),
                breakout_min_confidence: parseInt(document.getElementById('modal_breakout_min_confidence').value),
                scanBatchSize: parseInt(document.getElementById('modal_scanBatchSize').value),
                hotCoinScanInterval: parseInt(document.getElementById('modal_hotCoinScanInterval').value),
                maxHotCoins: parseInt(document.getElementById('modal_maxHotCoins').value)
            };

            try {
                const response = await fetch('/api/config/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ ML Ayarlarƒ± g√ºncellendi!');
                    closeModal();
                    await fetchData();
                } else {
                    alert('‚ùå ' + (result.message || 'Ayarlar kaydedilemedi'));
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-save"></i> Kaydet';
                }
            } catch (error) {
                alert('‚ùå ML Kayƒ±t sƒ±rasƒ±nda hata: ' + error.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save"></i> Kaydet';
            }
        }

        function closeModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.remove();
        }

        // Signal modal
        function openSignalModal(signal) {
            const modal = document.getElementById('signalModal');
            const body = document.getElementById('signalModalBody');
            const title = document.getElementById('signalModalTitle');
            if (!modal || !body || !title || !signal) return;

            title.innerHTML = `${signal.taraf === 'LONG' ? '<span class=direction-long>LONG</span>' : '<span class=direction-short>SHORT</span>'} - ${signal.coin}`;
            body.innerHTML = `
                <div><strong>Strateji:</strong> <span>${signal.strategy || signal.tip} (${signal.zaman_araligi || '-'})</span></div>
                <div><strong>Giri≈ü:</strong> <span>${signal.giris ?? '---'}</span></div>
                <div><strong>TP1:</strong> <span style="color: var(--accent-green);">${signal.tp1 ?? '---'} (+%${signal.profitPercent1 ?? '--'})</span></div>
                <div><strong>TP2:</strong> <span style="color: var(--accent-green);">${signal.tp2 ?? '---'} (+%${signal.profitPercent2 ?? '--'})</span></div>
                <div><strong>SL:</strong> <span style="color: var(--accent-red);">${signal.sl ?? '---'} (-%${signal.riskPercent ?? '--'})</span></div>
                <div><strong>R/R (TP1):</strong> <span>${signal.riskReward ?? '--'}</span></div>
                <div><strong>G√ºven:</strong> <span style="color:${getConfidenceColor(signal.confidence)}">${signal.confidence ?? '--'}%</span></div>
                <div><strong>Hacim:</strong> <span style="color:${getLabelColor(signal.hacim_durumu)}">${signal.hacim_durumu ?? '--'}</span></div>
                <div><strong>√ñng√∂r√º:</strong> <span>${signal.tuyo ?? '-'}</span></div>
                <div><strong>Analiz:</strong> <span>${signal.hacim_analizi ?? '-'}</span></div>
                <div style="margin-top:0.5rem;"><a href="${signal.tv_link || '#'}" target="_blank" class="btn btn-primary" style="width: 100%;"><i class="fas fa-external-link-alt"></i> TradingView'de A√ß</a></div>
            `;
            modal.style.display = 'flex';
        }
        function closeSignalModal() {
            const modal = document.getElementById('signalModal');
            if (modal) modal.style.display = 'none';
        }

        window.addEventListener('error', function(event) { console.error('üö® ML Global hata:', event.error); });
        window.addEventListener('beforeunload', function() { if (wsConnection) wsConnection.close(); });
    </script>
</body>
</html>
