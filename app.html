<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sonny AI Trader - Destek/Direnç Stratejisi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg-dark:#05070D;--bg-card:#101522;--bg-hover:#1A2235;--bg-overlay:rgba(16,21,34,.85);
      --accent-blue:#00BFFF;--accent-blue-hover:#0099CC;--accent-green:#00FFAA;--accent-red:#FF4D4D;
      --accent-yellow:#F59E0B;--accent-purple:#9370DB;--text-primary:#FFFFFF;--text-secondary:#B0C4DE;
      --text-muted:#708090;--border-light:rgba(173,216,230,.15);--shadow-deep:0 10px 30px rgba(0,0,0,.3)
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg-dark);color:var(--text-primary);font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;line-height:1.6}
    .header{background:var(--bg-card);border-bottom:1px solid var(--border-light);padding:1rem 2rem;position:sticky;top:0;z-index:1000;backdrop-filter:blur(10px);background-color:rgba(28,35,51,.85)}
    .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1800px;margin:0 auto}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:36px;height:36px;background:var(--accent-blue);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
    .logo-text{font-size:1.4rem;font-weight:700;color:var(--text-primary)}
    .version{background:var(--accent-blue);color:var(--bg-dark);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:700;margin-left:8px}
    .container{max-width:1800px;margin:0 auto;padding:1.5rem 2rem}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
    .metric-card{background:var(--bg-card);border-radius:8px;padding:1.25rem 1.5rem;border:1px solid var(--border-light);border-left:4px solid var(--accent-blue);transition:.3s}
    .metric-card:hover{transform:translateY(-3px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .metric-label{color:var(--text-secondary);font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .metric-value{font-size:1.75rem;font-weight:700;margin-top:.25rem}
    .metric-positive{color:var(--accent-green)}
    .metric-negative{color:var(--accent-red)}
    .control-panel{background:var(--bg-card);border:1px solid var(--border-light);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;display:flex;flex-direction:column;gap:1rem}
    .control-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
    .control-buttons{display:flex;flex-wrap:wrap;gap:.75rem}
    .btn{padding:.5rem 1rem;border:none;border-radius:8px;font-weight:600;font-size:.8rem;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:.5rem}
    .btn:disabled{background-color:var(--text-muted)!important;color:var(--bg-card)!important;cursor:not-allowed!important;opacity:.5}
    .btn-primary{background:var(--accent-blue);color:var(--bg-dark)}
    .btn-primary:hover{background:var(--accent-blue-hover)}
    .btn-success{background:var(--accent-green);color:#000}
    .btn-danger{background:var(--accent-red);color:#fff}
    .btn-outline{background:transparent;border:1px solid var(--border-light);color:var(--text-secondary)}
    .status-connected{background:rgba(0,255,170,.1);color:var(--accent-green);border:1px solid rgba(0,255,170,.2);padding:.4rem .8rem;border-radius:20px;font-size:.8rem;font-weight:700}
    .status-disconnected{background:rgba(255,77,77,.1);color:var(--accent-red);border:1px solid rgba(255,77,77,.2);padding:.4rem .8rem;border-radius:20px;font-size:.8rem;font-weight:700}
    .table-container{background:var(--bg-card);border:1px solid var(--border-light);border-radius:12px;overflow-x:auto;margin-bottom:1.5rem}
    .table-header{background:var(--bg-hover);padding:1rem 1.5rem;border-bottom:1px solid var(--border-light)}
    .table-title{font-size:1.1rem;font-weight:600;color:var(--text-primary);display:flex;align-items:center;gap:.75rem}
    table{width:100%;border-collapse:collapse;min-width:1200px}
    th{background:var(--bg-hover);padding:.8rem 1.25rem;text-align:left;font-weight:600;color:var(--text-secondary);font-size:.8rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border-light)}
    td{padding:.9rem 1.25rem;border-bottom:1px solid var(--border-light);font-size:.9rem;vertical-align:middle}
    tbody tr[onclick]:hover{background:var(--bg-hover);cursor:pointer}
    .direction-long{color:var(--accent-green);font-weight:700}
    .direction-short{color:var(--accent-red);font-weight:700}
    .strategy-badge{font-size:.75rem;padding:3px 8px;border-radius:6px;font-weight:700}
    .sr-badge{background:var(--accent-purple);color:#fff}
    .momentum-badge{background:var(--accent-yellow);color:#000}
    .ai-badge{background:var(--accent-blue);color:#000;padding:3px 8px;border-radius:6px;font-size:.75rem;font-weight:700}
    .signal-subtext{font-size:.75rem;color:var(--text-muted)}
    .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-overlay);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:10000;padding:1rem}
    .modal-content{background:var(--bg-card);border-radius:12px;padding:1rem 1.25rem;width:100%;max-width:600px;border:1px solid var(--border-light)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;padding-bottom:.5rem;border-bottom:1px solid var(--border-light)}
    .modal-title{font-size:1.1rem;font-weight:700;color:var(--text-primary)}
    .close-btn{background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;padding:.25rem}
    .setting-input{width:100%;padding:.5rem;border-radius:6px;border:1px solid var(--border-light);background:var(--bg-card);color:var(--text-primary);margin-top:.25rem}
    @media (max-width:768px){.container{padding:1rem}table{min-width:1000px}}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
        <div class="logo-text">Sonny AI Trader <span class="version">Destek/Direnç</span></div>
      </div>
      <div id="connectionStatus" class="status-disconnected">
        <i class="fas fa-circle"></i> <span>Bağlanıyor...</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="metrics-grid">
      <div class="metric-card"><div class="metric-label">Toplam Bakiye</div><div class="metric-value" id="metricEquity">$---</div></div>
      <div class="metric-card"><div class="metric-label">Kullanılabilir</div><div class="metric-value" id="metricAvailable">$---</div></div>
      <div class="metric-card"><div class="metric-label">Açık PNL</div><div class="metric-value" id="metricPnl">$0.00</div></div>
      <div class="metric-card"><div class="metric-label">Günlük K/Z</div><div class="metric-value" id="metricDailyPL">$0.00</div></div>
      <div class="metric-card"><div class="metric-label">Günlük İşlem</div><div class="metric-value" id="metricDailyTrades">0</div></div>
      <div class="metric-card"><div class="metric-label">Aktif Sinyaller</div><div class="metric-value" id="metricActiveSignals">0</div></div>
    </div>

    <div class="control-panel">
      <div class="control-row">
        <div class="control-buttons">
          <button class="btn btn-primary" onclick="openRiskSettings()"><i class="fas fa-sliders-h"></i> Destek/Direnç Ayarları</button>
          <button class="btn btn-success" id="masterAutotradeBtn" onclick="toggleMasterAutotrade()"><i class="fas fa-play"></i> Autotrade: KAPALI</button>
          <button class="btn btn-outline" onclick="fetchData()"><i class="fas fa-sync-alt"></i> Yenile</button>
        </div>
        <div id="strategyToggles" style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button class="btn btn-outline" id="toggleSR" onclick="toggleStrategy('autoTradeSupportResistance')">Destek/Direnç: AÇIK</button>
          <button class="btn btn-outline" id="toggleVolume" onclick="toggleStrategy('sr_volume_confirmation')">Volume Onay: AÇIK</button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-title"><i class="fas fa-bolt"></i> Destek/Direnç Kırılım Sinyalleri <span class="ai-badge" id="signalsCount">0</span></div>
      </div>
      <table>
        <thead><tr><th>Coin</th><th>Yön</th><th>Timeframe</th><th>Güven</th><th>Giriş</th><th>TP1 / SL</th><th>R/R</th><th>Seviye Analizi</th><th>İşlem</th></tr></thead>
        <tbody id="signalsBody"><tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;">Destek/Direnç taraması aktif...</td></tr></tbody>
      </table>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-title"><i class="fas fa-chart-line"></i> Açık Pozisyonlar <span class="ai-badge" id="positionsCount">0</span></div>
      </div>
      <table>
        <thead><tr><th>Sembol</th><th>Yön</th><th>Strateji</th><th>Giriş</th><th>Anlık</th><th>K/Z</th><th>Kaldıraç</th><th>Süre</th><th>İşlem</th></tr></thead>
        <tbody id="positionsBody"><tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;"><i class="fas fa-box-open"></i> Aktif pozisyon yok</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="modal-backdrop" id="signalModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="signalModalTitle">Sinyal Detayı</div>
        <button class="close-btn" onclick="closeSignalModal()">&times;</button>
      </div>
      <div id="signalModalBody"></div>
    </div>
  </div>
  <div id="modal-placeholder"></div>

  <script>
    let supportResistanceSignals = [];
    let openPositions = [];
    let currentConfig = {};
    let wsConnection = null;

    document.addEventListener('DOMContentLoaded', () => {
      connectWS();
      fetchData();
      setInterval(fetchData, 7000);
    });

    function connectWS(){
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = protocol + '//' + window.location.host;
      wsConnection = new WebSocket(wsUrl);
      wsConnection.onopen = () => updateConnectionStatus(true);
      wsConnection.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data || '{}');
          if (!msg || !msg.type) return;
          if (msg.type === 'support_resistance_signals') { 
            supportResistanceSignals = Array.isArray(msg.data) ? msg.data : []; 
            renderSignals(); 
          }
          else if (msg.type === 'open_positions') { 
            openPositions = Array.isArray(msg.data) ? msg.data : []; 
            renderPositions(); 
          }
        } catch (e) { console.error('WS parse hata', e); }
      };
      wsConnection.onclose = () => updateConnectionStatus(false);
      wsConnection.onerror = () => updateConnectionStatus(false);
    }

    function updateConnectionStatus(ok){
      const el = document.getElementById('connectionStatus');
      el.className = ok ? 'status-connected' : 'status-disconnected';
      el.innerHTML = `<i class="fas fa-circle"></i> <span>${ok?'Bağlı':'Bağlantı Kesildi'}</span>`;
    }

    async function fetchData(){
      try {
        const [mRes, cRes] = await Promise.all([
          fetch('/api/metrics'),
          fetch('/api/config/status')
        ]);
        
        if (!mRes.ok) throw new Error('Metrics error: ' + mRes.status);
        if (!cRes.ok) throw new Error('Config error: ' + cRes.status);
        
        const metrics = await mRes.json();
        const status = await cRes.json();

        currentConfig = status || {};
        openPositions = status.openPositions || [];

        updateMetrics(metrics);
        updateMasterAutotradeButton(currentConfig.autoTradeSupportResistance);
        updateStrategyButtons();
        renderPositions();
        renderSignals();
      } catch (e) {
        console.error('Veri çekme hata', e?.message);
        updateConnectionStatus(false);
      }
    }

    function updateMetrics(metrics){
      const fmtMoney = v => (typeof v === 'number' && isFinite(v)) ? '$' + v.toFixed(2) : '$0.00';
      document.getElementById('metricEquity').textContent = fmtMoney(metrics?.totalEquity);
      document.getElementById('metricAvailable').textContent = fmtMoney(metrics?.availableMargin);

      const pnl = (typeof metrics?.unrealizedPnl === 'number') ? metrics.unrealizedPnl : 0;
      const pnlEl = document.getElementById('metricPnl');
      pnlEl.textContent = '$' + pnl.toFixed(2);
      pnlEl.className = 'metric-value ' + (pnl >= 0 ? 'metric-positive':'metric-negative');

      const dpl = (typeof metrics?.dailyPL === 'number') ? metrics.dailyPL : 0;
      const dplEl = document.getElementById('metricDailyPL');
      dplEl.textContent = '$' + dpl.toFixed(2);
      dplEl.className = 'metric-value ' + (dpl >= 0 ? 'metric-positive':'metric-negative');

      document.getElementById('metricDailyTrades').textContent = metrics?.dailyTrades || 0;
      document.getElementById('metricActiveSignals').textContent = supportResistanceSignals.length;
    }

    function renderSignals(){
      const tbody = document.getElementById('signalsBody');
      const count = document.getElementById('signalsCount');
      const signals = supportResistanceSignals || [];
      count.textContent = signals.length;

      if (signals.length === 0){
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;">Destek/Direnç taraması aktif...</td></tr>';
        return;
      }

      tbody.innerHTML = signals.map(s => {
        const tp1 = num(s.tp1), sl = num(s.sl), rr = safeText(s.riskReward);
        const timeframe = safeText(s.zaman_araligi) || '1H-4H';
        const levelAnalysis = safeText(s.analiz_notu) || safeText(s.ongoru) || 'Kırılım tespiti';
        
        return `
          <tr onclick="openSignalModalFromRow('${encodeURIComponent(JSON.stringify(s))}')">
            <td><strong>${safeText(s.coin)}</strong><div class="signal-subtext">${safeTime(s.timestamp)}</div></td>
            <td><span class="${s.taraf==='LONG'?'direction-long':'direction-short'}">${s.taraf}</span></td>
            <td><span class="strategy-badge sr-badge">${timeframe}</span></td>
            <td><span>${s.confidence || '--'}%</span></td>
            <td><strong>${num(s.giris)}</strong></td>
            <td><div>TP1: <span style="color:#00FFAA">${tp1}</span><br>SL: <span style="color:#FF4D4D">${sl}</span></div></td>
            <td><strong>${rr}</strong></td>
            <td>${levelAnalysis}</td>
            <td>
              <button class="btn btn-success" onclick="event.stopPropagation(); executeTrade('${encodeURIComponent(JSON.stringify(s))}')"><i class="fas fa-play"></i> Trade</button>
            </td>
          </tr>`;
      }).join('');
    }

    function renderPositions(){
      const tbody = document.getElementById('positionsBody');
      const count = document.getElementById('positionsCount');
      const list = openPositions || [];
      count.textContent = list.length;

      if (list.length === 0){
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;"><i class="fas fa-box-open"></i> Aktif pozisyon yok</td></tr>';
        return;
      }

      tbody.innerHTML = list.map(p => {
        const pnlClass = (p.unrealizedPnl || 0) >= 0 ? 'ai-badge' : 'strategy-badge momentum-badge';
        const duration = p.timestamp ? Math.round((Date.now()-p.timestamp)/60000) : 0;
        const strat = 'Destek/Direnç';
        return `
          <tr>
            <td><strong>${safeText(p.symbol)}</strong></td>
            <td><span class="${(p.side||'long')==='long'?'direction-long':'direction-short'}">${(p.side||'long').toUpperCase()}</span></td>
            <td><span class="strategy-badge sr-badge">${strat}</span></td>
            <td>${num(p.entryPrice)}</td>
            <td>${num(p.markPrice)}</td>
            <td><span class="${pnlClass}">${(p.unrealizedPnl||0)>=0?'+':''}$${Number(p.unrealizedPnl||0).toFixed(2)}</span></td>
            <td>${p.leverage || 5}x</td>
            <td>${duration} dk</td>
            <td><button class="btn btn-danger" onclick="closePositionUI('${safeText(p.symbol)}')"><i class="fas fa-stop"></i> Kapat</button></td>
          </tr>`;
      }).join('');
    }

    function updateMasterAutotradeButton(isEnabled){
      const btn = document.getElementById('masterAutotradeBtn');
      if (isEnabled){
        btn.innerHTML = '<i class="fas fa-stop"></i> Autotrade: AÇIK';
        btn.className = 'btn btn-danger';
      } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Autotrade: KAPALI';
        btn.className = 'btn btn-success';
      }
    }

    function updateStrategyButtons(){
      const srBtn = document.getElementById('toggleSR');
      const volumeBtn = document.getElementById('toggleVolume');
      
      if (srBtn) {
        srBtn.textContent = 'Destek/Direnç: ' + (currentConfig.autoTradeSupportResistance ? 'AÇIK' : 'KAPALI');
      }
      if (volumeBtn) {
        volumeBtn.textContent = 'Volume Onay: ' + (currentConfig.sr_volume_confirmation ? 'AÇIK' : 'KAPALI');
      }
    }

    async function toggleMasterAutotrade(){
      const newState = !(currentConfig.autoTradeSupportResistance || false);
      try {
        const res = await fetch('/api/config/update', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ autoTradeSupportResistance: newState })
        });
        const r = await res.json();
        if (r.success){ 
          currentConfig.autoTradeSupportResistance = newState; 
          updateMasterAutotradeButton(newState); 
          alert('Destek/Direnç Autotrade ' + (newState?'AÇIK':'KAPALI')); 
        }
        else alert('Değiştirilemedi');
      } catch(e){ alert('Sunucu hatası: ' + e.message); }
    }

    async function toggleStrategy(key){
      const newState = !(currentConfig[key] || false);
      try {
        const res = await fetch('/api/config/update', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ [key]: newState })
        });
        const r = await res.json();
        if (r.success){ 
          currentConfig[key] = newState; 
          updateStrategyButtons(); 
        }
        else alert('Değiştirilemedi');
      } catch(e){ alert('Sunucu hatası: ' + e.message); }
    }

    // Helpers
    function safeText(v){ 
      if (v === null || v === undefined) return '---'; 
      return String(v).substring(0, 50); 
    }
    function num(v){ 
      return (typeof v === 'number' && isFinite(v)) ? v.toFixed(6) : '---'; 
    }
    function safeTime(ts){ 
      const t = Number(ts); 
      return Number.isFinite(t) ? new Date(t).toLocaleTimeString('tr-TR') : '--:--'; 
    }

    // Trade execution
    async function executeTrade(encoded){
      try {
        const s = JSON.parse(decodeURIComponent(encoded));
        const res = await fetch('/api/autotrade/manual', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(s)
        });
        const r = await res.json();
        if (r.success){ 
          alert('Emir gönderildi: ' + s.coin); 
          fetchData(); 
        }
        else alert('Hata: ' + r.message);
      } catch(e){ alert('Trade hatası: ' + e.message); }
    }

    async function closePositionUI(symbol){
      if (!confirm(symbol + ' pozisyonunu kapatmak istiyor musun?')) return;
      try {
        const res = await fetch('/api/force-remove-position', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ symbol })
        });
        const r = await res.json();
        if (r.success){ 
          alert('Kapatıldı'); 
          fetchData(); 
        }
        else alert('Hata: ' + r.message);
      } catch(e){ alert('Kapatma hatası: ' + e.message); }
    }

    // Sinyal modal
    function openSignalModalFromRow(encoded){
      try {
        const s = JSON.parse(decodeURIComponent(encoded));
        openSignalModal(s);
      } catch(e){ console.error('Sinyal parse', e); }
    }

    function openSignalModal(signal){
      const modal = document.getElementById('signalModal');
      const body = document.getElementById('signalModalBody');
      const title = document.getElementById('signalModalTitle');
      if (!modal || !body || !title) return;

      title.innerHTML = `${signal.taraf==='LONG'?'<span class=direction-long>LONG</span>':'<span class=direction-short>SHORT</span>'} - ${safeText(signal.coin)}`;
      
      const levelType = signal.taraf === 'LONG' ? 'Direnç' : 'Destek';
      const analysis = signal.analiz_notu || signal.ongoru || 'Seviye kırılımı tespit edildi';
      
      body.innerHTML = `
        <div style="display: grid; gap: 0.5rem;">
          <div><strong>Strateji:</strong> <span class="strategy-badge sr-badge">Destek/Direnç Kırılım</span></div>
          <div><strong>Timeframe:</strong> <span>${signal.zaman_araligi || '1H-4H'}</span></div>
          <div><strong>Kırılan Seviye:</strong> <span>${levelType}</span></div>
          <div><strong>Giriş:</strong> <span>${signal.giris ?? '---'}</span></div>
          <div><strong>TP1:</strong> <span style="color:#00FFAA">${signal.tp1 ?? '---'} (+%${signal.profitPercent1 ?? '--'})</span></div>
          <div><strong>TP2:</strong> <span style="color:#00FFAA">${signal.tp2 ?? '---'} (+%${signal.profitPercent2 ?? '--'})</span></div>
          <div><strong>SL:</strong> <span style="color:#FF4D4D">${signal.sl ?? '---'} (-%${signal.riskPercent ?? '--'})</span></div>
          <div><strong>R/R (TP1):</strong> <span>${signal.riskReward ?? '--'}</span></div>
          <div><strong>Güven:</strong> <span>${signal.confidence ?? '--'}%</span></div>
          <div><strong>Analiz:</strong> <span>${analysis}</span></div>
          <div><strong>Volume Durumu:</strong> <span>${signal.hacim_durumu || '---'}</span></div>
          <div style="margin-top:.5rem;">
            <a href="${signal.tv_link || '#'}" target="_blank" class="btn btn-primary" style="width:100%"><i class="fas fa-external-link-alt"></i> TradingView'de İncele</a>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function closeSignalModal(){
      const modal = document.getElementById('signalModal');
      if (modal) modal.style.display = 'none';
    }

    // Ayarlar modal
    function openRiskSettings(){
      const m = document.getElementById('modal-placeholder');
      const c = currentConfig || {};
      m.innerHTML = `
        <div class="modal-backdrop" id="settings-modal" style="display:flex">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title"><i class="fas fa-sliders-h"></i> Destek/Direnç Ayarları</div>
              <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div>
              <div style="margin:.5rem 0"><strong>Autotrade:</strong> ${c.autoTradeSupportResistance?'AÇIK':'KAPALI'} | <strong>Volume Onay:</strong> ${c.sr_volume_confirmation?'AÇIK':'KAPALI'}</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem">
                <div><label>Kaldıraç</label><input id="f_leverage" type="number" class="setting-input" value="${c.leverage||10}" /></div>
                <div><label>Marjin %</label><input id="f_margin" type="number" class="setting-input" value="${c.marginPercent||3}" /></div>
                <div><label>Min Güven</label><input id="f_confidence" type="number" class="setting-input" value="${c.sr_min_confidence||65}" /></div>
                <div><label>Kırılım Threshold %</label><input id="f_threshold" type="number" class="setting-input" step="0.01" value="${((c.sr_breakout_threshold||0.002)*100).toFixed(2)}" /></div>
                <div><label>Lookback Periods</label><input id="f_lookback" type="number" class="setting-input" value="${c.sr_lookback_periods||50}" /></div>
                <div><label>Min Volume Çarpan</label><input id="f_volume" type="number" class="setting-input" step="0.1" value="${c.sr_min_volume_multiplier||1.5}" /></div>
                <div><label>Tarama Aralığı (sn)</label><input id="f_scan" type="number" class="setting-input" value="${Math.round((c.scanInterval||60000)/1000)}" /></div>
                <div><label>Maks Pozisyon</label><input id="f_maxpos" type="number" class="setting-input" value="${c.maxPositions||3}" /></div>
              </div>
              <div style="display:flex;gap:1rem;margin-top:1rem">
                <button class="btn btn-primary" onclick="saveSettings(this)"><i class="fas fa-save"></i> Kaydet</button>
                <button class="btn btn-outline" onclick="closeModal()"><i class="fas fa-times"></i> İptal</button>
              </div>
            </div>
          </div>
        </div>`;
    }

    async function saveSettings(btn){
      btn.disabled = true; 
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
      
      const payload = {
        leverage: parseFloat(document.getElementById('f_leverage').value),
        marginPercent: parseFloat(document.getElementById('f_margin').value),
        sr_min_confidence: parseInt(document.getElementById('f_confidence').value),
        sr_breakout_threshold: parseFloat(document.getElementById('f_threshold').value) / 100,
        sr_lookback_periods: parseInt(document.getElementById('f_lookback').value),
        sr_min_volume_multiplier: parseFloat(document.getElementById('f_volume').value),
        scanInterval: parseInt(document.getElementById('f_scan').value) * 1000,
        maxPositions: parseInt(document.getElementById('f_maxpos').value)
      };
      
      try {
        const res = await fetch('/api/config/update', {
          method:'POST', 
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const r = await res.json();
        if (r.success){ 
          alert('Ayarlar kaydedildi'); 
          closeModal(); 
          fetchData(); 
        } else {
          alert('Kaydedilemedi: ' + (r.message || 'Bilinmeyen hata'));
        }
      } catch(e){ 
        alert('Sunucu hatası: ' + e.message); 
      }
      
      btn.disabled = false; 
      btn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
    }

    function closeModal(){
      const m = document.getElementById('settings-modal');
      if (m) m.remove();
    }
  </script>
</body>
</html>
