<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonny AI Trader - Gelişmiş Sinyal Sistemi</title>
    <!-- Socket.io İstemci Kütüphanesi -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #1e1e1e; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); overflow: hidden; }
        header { padding: 20px; background-color: #2a2a2a; border-bottom: 1px solid #333; }
        header h1 { color: #4CAF50; margin: 0; }
        #scan-status { font-size: 0.9em; color: #bbb; margin-top: 8px; display: flex; align-items: center; }
        #scan-spinner { width: 16px; height: 16px; border: 2px solid #555; border-top-color: #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Manuel Analiz Formu */
        .manual-analysis { padding: 20px; background-color: #252525; display: flex; gap: 10px; flex-direction: column; }
        .manual-input-row { display: flex; gap: 10px; }
        .manual-analysis input[type="text"] { flex-grow: 1; padding: 10px; background-color: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 1em; }
        .manual-analysis button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .manual-analysis button:hover:not(:disabled) { background-color: #45a049; }
        .manual-analysis button:disabled { background-color: #555; cursor: not-allowed; }
        
        /* Manuel Analiz Sonuç Kutusu */
        #manual-result-wrapper { 
            position: relative; 
            padding: 15px; 
            margin-top: 10px;
            border-radius: 6px; 
            font-size: 1.1em; 
            line-height: 1.5; 
            background-color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: none;
        }
        .manual-close-btn { 
            position: absolute; 
            top: 5px; 
            right: 10px; 
            background: none; 
            border: none; 
            color: #ccc; 
            font-size: 1.2em; 
            cursor: pointer; 
        }
        .manual-result-title { font-weight: bold; margin-bottom: 5px; color: #4CAF50; }
        .manual-result-text { font-size: 0.9em; color: #ccc; }
        .manual-signal-box { font-size: 1.2em; font-weight: bold; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-right: 10px; }
        .bg-long { background-color: #4CAF50; color: white; }
        .bg-short { background-color: #F44336; color: white; }
        .bg-wait { background-color: #FFC107; color: #333; }


        /* Sinyal Tablosu */
        .table-wrapper { overflow-x: auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2a2a2a; cursor: pointer; user-select: none; }
        th:hover { background-color: #333; }
        th .sort-icon { margin-left: 5px; font-size: 0.8em; }
        tr:nth-child(even) { background-color: #232323; }
        
        /* Renk Sınıfları */
        .signal-long { color: #4CAF50; font-weight: bold; }
        .signal-short { color: #F44336; font-weight: bold; }
        .signal-wait { color: #FFC107; }
        .link-text { color: #79a6d2; text-decoration: none; }
        .link-text:hover { text-decoration: underline; }
        
        /* Durum Renklendirmesi (Açıklama/Sebep Sütunu) */
        /* Bu sınıflar, belirgin arka plan rengi eklemek için ayarlandı */
        .status-onay { background-color: #2E4733; color: #4CAF50; font-weight: bold; } /* SAĞLAM ONAY */
        .status-reddet { background-color: #472E2E; color: #F44336; font-weight: bold; } /* REDDEDİLDİ */
        .status-yuksek { color: #8BC34A; } /* Hacim Yüksek */
        .status-duyuru { color: #FFC107; } /* Tarama Duyurusu */
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Sonny AI Trader</h1>
            <div id="scan-status">
                <div id="scan-spinner"></div>
                <span id="scan-status-text">Sunucuya bağlanılıyor...</span>
            </div>
        </header>

        <div class="manual-analysis">
            <div class="manual-input-row">
                <input type="text" id="symbol-input" placeholder="Manuel Analiz (örn: ATOM veya ETHUSDT)">
                <button id="analyze-button">Analiz Et</button>
            </div>
            <div id="manual-result-wrapper">
                <button class="manual-close-btn" id="manual-close-btn">&times;</button>
                <div id="manual-result"></div>
            </div>
        </div>
        
        <!-- ***** OTOMATİK SİNYAL YERİ BURASI ***** -->
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th data-sort="time" class="sorted-asc">Zaman <span class="sort-icon">&#9660;</span></th>
                        <th data-sort="symbol">Sembol</th>
                        <th data-sort="signal">Yön</th>
                        <th data-sort="confidence">Güven %</th>
                        <th data-sort="riskRewardRatio">R/R Oranı</th>
                        <th>TP / SL (Öneri)</th>
                        <th data-sort="volumeStatus">Hacim</th>
                        <th>Açıklama / Strateji</th>
                    </tr>
                </thead>
                <tbody id="signal-table-body">
                    <!-- Sinyaller buraya yerleşecektir -->
                </tbody>
            </table>
        </div>
        <!-- ***** OTOMATİK SİNYAL YERİ BİTİŞ ***** -->

    </div>

    <script>
        // --- GLOBAL DEĞİŞKENLER ---
        const signalTableBody = document.getElementById('signal-table-body');
        const scanStatusText = document.getElementById('scan-status-text');
        const scanSpinner = document.getElementById('scan-spinner');
        const symbolInput = document.getElementById('symbol-input');
        const analyzeButton = document.getElementById('analyze-button');
        const manualResultWrapper = document.getElementById('manual-result-wrapper');
        const manualResultDiv = document.getElementById('manual-result');
        const manualCloseBtn = document.getElementById('manual-close-btn');

        let allSignals = []; // Tüm sinyalleri burada tutacağız

        // --- WebSocket Bağlantısı ---
        // Port belirtmeye gerek yok, aynı adresten bağlanacak
        const socket = io();

        // --- WebSocket Dinleyicileri ---
        socket.on('connect', () => {
            console.log('Sunucuya bağlandı!');
            scanStatusText.textContent = 'Sunucuya bağlandı. Tarama bekleniyor...';
        });

        socket.on('initial_state', (data) => {
            console.log('Sunucudan mevcut durum alındı.');
            updateScanStatus(data.scanStatus);
            allSignals = data.signals;
            renderSignals(); 
        });

        socket.on('scan_status', (status) => {
            updateScanStatus(status);
        });

        socket.on('yeni_sinyal', (signal) => {
            console.log('!!! ANLIK YENİ SİNYAL GELDİ !!!', signal);
            // Sinyal listeye eklenir, ardından sıralanmış tablo yeniden çizilir
            const existingIndex = allSignals.findIndex(s => s.id === signal.id);
            if (existingIndex === -1) {
                 allSignals.unshift(signal); // Yeni sinyali listenin başına ekle
                 renderSignals(signal); // Animasyonlu yeniden çiz
            }
        });

        socket.on('disconnect', () => {
            console.error('Sunucu bağlantısı koptu!');
            scanStatusText.textContent = 'Sunucu bağlantısı koptu! Yeniden bağlanılıyor...';
            scanSpinner.style.display = 'block';
        });

        // --- Yardımcı Fonksiyonlar ---

        function updateScanStatus(status) {
            scanStatusText.textContent = status.message;
            scanSpinner.style.display = status.isScanning ? 'block' : 'none';
        }

        function renderSignals(newSignal = null) {
            // Sinyalleri mevcut sıralama düzenine göre sırala
            const { key, direction } = getSortState();
            sortSignals(key, direction);

            signalTableBody.innerHTML = ''; // Tabloyu temizle

            allSignals.forEach((signal) => {
                const row = document.createElement('tr');
                // Sinyalin ID'si ile kontrol edilir
                const isNew = newSignal && signal.id === newSignal.id; 
                
                const signalClass = signal.signal === 'LONG' ? 'signal-long' : (signal.signal === 'SHORT' ? 'signal-short' : 'signal-wait');
                const reasonClass = getReasonClass(signal.reason);
                const volumeClass = signal.volumeStatus === 'Yüksek' ? 'status-yuksek' : '';
                
                const tradingViewSymbol = signal.symbol.replace('USDT', 'USDT.P');

                row.innerHTML = `
                    <td>${formatTime(signal.time)}</td>
                    <td><a href="https://www.tradingview.com/chart/?symbol=BITGET:${tradingViewSymbol}" target="_blank" class="link-text">${signal.symbol}</a></td>
                    <td class="${signalClass}">${signal.signal}</td>
                    <td>${signal.confidence}%</td>
                    <td>${signal.riskRewardRatio || '---'}</td>
                    <td>TP: ${signal.TP} / SL: ${signal.SL}</td>
                    <td class="${volumeClass}">${signal.volumeStatus}</td>
                    <td class="${reasonClass}">${signal.reason}</td>
                `;

                if (isNew) {
                    row.classList.add('new-signal-row'); // Yeni sinyal animasyonu
                }

                signalTableBody.appendChild(row);
            });
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '---';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        function getReasonClass(reason) {
            if (reason.includes('SAĞLAM ONAY')) return 'status-onay';
            if (reason.includes('REDDEDİLDİ')) return 'status-reddet';
            return ''; // Diğer durumlar (BEKLE, vb.) için varsayılan
        }


        // --- Sıralama Mantığı ---

        let sortState = { key: 'time', direction: 'desc' }; // Varsayılan: Zamana göre azalan (en yeni en üstte)

        function getSortState() { return sortState; }

        function sortSignals(key, direction) {
            allSignals.sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];

                if (key === 'time') { 
                    aVal = aVal || 0; bVal = bVal || 0;
                } else if (key === 'confidence' || key === 'riskRewardRatio') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (key === 'signal' || key === 'symbol' || key === 'volumeStatus') {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                }

                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
        }
        
        // Başlıklar için sıralama olay dinleyicisi
        document.addEventListener('DOMContentLoaded', () => {
             document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.getAttribute('data-sort');
                    const currentDirection = sortState.key === key ? sortState.direction : 'asc';
                    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    
                    // Başlık ikonlarını güncelle
                    document.querySelectorAll('th .sort-icon').forEach(icon => icon.innerHTML = '');
                    const iconSpan = header.querySelector('.sort-icon');
                    if (iconSpan) {
                        iconSpan.innerHTML = newDirection === 'asc' ? '&#9650;' : '&#9660;';
                    }
                    
                    sortState = { key: key, direction: newDirection };
                    renderSignals(); // Yeni sıralamaya göre tabloyu yeniden çiz
                });
            });
        });


        // --- Manuel Analiz ---
        analyzeButton.addEventListener('click', async () => {
            const symbol = symbolInput.value;
            if (!symbol) return;

            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analiz...';
            manualResultWrapper.style.display = 'none';

            try {
                const response = await fetch('/api/analyze-coin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });
                const result = await response.json();
                
                manualResultWrapper.style.display = 'block';
                manualResultDiv.innerHTML = renderManualResult(result);

            } catch (err) {
                manualResultWrapper.style.display = 'block';
                manualResultDiv.innerHTML = `<div class="manual-result-title" style="color:#f44336;">HATA</div><div class="manual-result-text">API isteği başarısız: Sunucuya ulaşılamıyor veya Sembol bulunamadı.</div>`;
                console.error('API isteği başarısız:', err);
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analiz Et';
            }
        });

        // Manuel Sonuç Kapatma
        manualCloseBtn.addEventListener('click', () => {
            manualResultWrapper.style.display = 'none';
        });


        function renderManualResult(result) {
            if (result.error) {
                return `<div class="manual-result-title" style="color:#f44336;">HATA</div><div class="manual-result-text">${result.error}</div>`;
            }

            const signalClass = result.signal === 'LONG' ? 'bg-long' : (result.signal === 'SHORT' ? 'bg-short' : 'bg-wait');
            const rrText = result.riskRewardRatio ? `R/R: ${result.riskRewardRatio}` : 'R/R: ---';
            const priceLink = `<a href="https://www.tradingview.com/chart/?symbol=BITGET:${result.symbol.replace('USDT', 'USDT.P')}" target="_blank" class="link-text" style="font-size:1.2em;">${result.symbol}</a>`;
            const reasonClass = getReasonClass(result.reason);

            return `
                <div class="manual-result-title">Manuel Analiz Sonucu (${formatTime(result.time)})</div>
                <div style="margin-bottom: 10px;">${priceLink} <span class="${signalClass} manual-signal-box">${result.signal}</span></div>
                <div class="manual-result-text">
                    <p><strong>Fiyat:</strong> ${result.price} | <strong>Güven:</strong> ${result.confidence}% | <strong>Hacim:</strong> ${result.volumeStatus}</p>
                    <p><strong>TP/SL:</strong> TP: ${result.TP} / SL: ${result.SL} | <strong>${rrText}</strong></p>
                    <p><strong>Açıklama:</strong> <span class="${reasonClass}">${result.reason}</span></p>
                </div>
            `;
        }
    </script>
</body>
</html>