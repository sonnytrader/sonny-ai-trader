<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Dashboard - ALPHASON TRADER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-blue-400">ALPHASON TRADER</h1>
      <div class="flex items-center space-x-4">
        <span id="userEmail" class="text-gray-300">admin@alphason.com</span>
        <button id="btnLogout" class="btn btn-secondary">Çıkış</button>
      </div>
    </header>

    <!-- System Status -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="card rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-400" id="balance">$0</div>
        <div class="text-sm text-gray-400">Bakiye</div>
      </div>
      <div class="card rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-400" id="signalCount">0</div>
        <div class="text-sm text-gray-400">Sinyaller</div>
      </div>
      <div class="card rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-400" id="positionCount">0</div>
        <div class="text-sm text-gray-400">Pozisyonlar</div>
      </div>
      <div class="card rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-purple-400" id="winRate">0%</div>
        <div class="text-sm text-gray-400">Win Rate</div>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Signals Panel -->
      <div class="lg:col-span-2">
        <div class="card rounded-xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Sinyaller</h2>
            <div class="flex space-x-2">
              <button id="btnScan" class="btn btn-primary">Tara</button>
              <button id="btnRefresh" class="btn btn-secondary">Yenile</button>
            </div>
          </div>
          <div id="signals" class="space-y-3 max-h-96 overflow-y-auto">
            <div class="text-center text-gray-500 py-8">Sinyal yükleniyor...</div>
          </div>
        </div>

        <!-- Manual Trade -->
        <div class="card rounded-xl p-6 mt-6">
          <h3 class="text-xl font-bold mb-4">Manuel İşlem</h3>
          <div class="grid md:grid-cols-5 gap-3 mb-3">
            <input id="manSymbol" class="input" placeholder="BTC/USDT:USDT" value="BTC/USDT:USDT">
            <select id="manDirection" class="input">
              <option value="LONG">LONG</option>
              <option value="SHORT">SHORT</option>
            </select>
            <input id="manAmount" class="input" placeholder="Miktar" value="0.01">
            <input id="manPrice" class="input" placeholder="Fiyat (limit)">
            <select id="manType" class="input">
              <option value="limit">Limit</option>
              <option value="market">Market</option>
            </select>
          </div>
          <button id="btnManualTrade" class="btn btn-success">İşlem Gönder</button>
          <p id="manMsg" class="mt-2 text-sm text-gray-300"></p>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="space-y-6">
        <!-- Positions -->
        <div class="card rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4">Açık Pozisyonlar</h3>
          <div id="positions" class="space-y-3">
            <div class="text-center text-gray-500 py-4">Pozisyon yok</div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4">Sistem Durumu</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Market Sentiment:</span>
              <span id="marketSentiment" class="font-medium">-</span>
            </div>
            <div class="flex justify-between">
              <span>Toplam Sinyal:</span>
              <span id="totalSignals" class="font-medium">0</span>
            </div>
            <div class="flex justify-between">
              <span>İşlem Sayısı:</span>
              <span id="totalTrades" class="font-medium">0</span>
            </div>
            <div class="flex justify-between">
              <span>Son Güncelleme:</span>
              <span id="lastUpdate" class="font-medium">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div class="card rounded-xl p-6 mt-6">
      <h3 class="text-2xl font-bold mb-4">Ayarlar</h3>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="label">Min Güven (%)</label>
          <input id="confMin" type="number" class="input" value="60" min="0" max="100">
        </div>
        <div>
          <label class="label">Emir Tipi</label>
          <select id="orderType" class="input">
            <option value="limit">Limit</option>
            <option value="market">Market</option>
          </select>
        </div>
        <div>
          <label class="label">Kaldıraç</label>
          <input id="leverage" type="number" class="input" value="10" min="1" max="100">
        </div>
        <div>
          <label class="label">Risk Profili</label>
          <select id="riskProfile" class="input">
            <option value="conservative">Conservative</option>
            <option value="balanced" selected>Balanced</option>
            <option value="aggressive">Aggressive</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input id="scalp" type="checkbox" class="w-4 h-4">
          <label class="label mb-0">Scalp modu</label>
        </div>
        <div class="flex items-center gap-2">
          <input id="autotrade" type="checkbox" class="w-4 h-4">
          <label class="label mb-0">Oto trade aktif</label>
        </div>
        <div class="md:col-span-2">
          <label class="label">Stratejiler</label>
          <div class="grid grid-cols-3 gap-2 mt-1">
            <label class="flex items-center gap-2">
              <input id="stgBreakout" type="checkbox" checked class="w-4 h-4">
              <span class="text-sm">Breakout</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="stgTrend" type="checkbox" checked class="w-4 h-4">
              <span class="text-sm">TrendFollow</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="stgPump" type="checkbox" checked class="w-4 h-4">
              <span class="text-sm">PumpDump</span>
            </label>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <button id="btnSaveCfg" class="btn btn-primary">Ayarları Kaydet</button>
        <p id="cfgMsg" class="mt-2 text-sm text-gray-300"></p>
      </div>
    </div>
  </div>

  <script>
    let authToken = localStorage.getItem('authToken') || 'demo-token';
    let ws = null;

    // DOM Elements
    const elements = {
      signals: document.getElementById('signals'),
      positions: document.getElementById('positions'),
      balance: document.getElementById('balance'),
      signalCount: document.getElementById('signalCount'),
      positionCount: document.getElementById('positionCount'),
      winRate: document.getElementById('winRate'),
      marketSentiment: document.getElementById('marketSentiment'),
      totalSignals: document.getElementById('totalSignals'),
      totalTrades: document.getElementById('totalTrades'),
      lastUpdate: document.getElementById('lastUpdate')
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserConfig();
      await loadSystemStatus();
      connectWebSocket();
      setupEventListeners();
    });

    // WebSocket Connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'signal_list') {
            updateSignals(data.data);
          }
        } catch (e) {
          console.error('WebSocket message error:', e);
        }
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 3000);
      };
    }

    // API Functions
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(endpoint, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': authToken
          },
          ...options
        });
        
        if (response.status === 401) {
          localStorage.removeItem('authToken');
          window.location.href = '/login';
          return;
        }
        
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        return { success: false, error: error.message };
      }
    }

    async function loadUserConfig() {
      const result = await apiCall('/api/user/config');
      if (result.success) {
        updateUIConfig(result.config);
      }
    }

    async function loadSystemStatus() {
      const result = await apiCall('/api/status');
      if (result.success) {
        updateSystemStatus(result);
      }
    }

    async function scanSignals() {
      const result = await apiCall('/api/signals/scan', {
        method: 'POST'
      });
      
      if (result.success) {
        updateSignals(result.signals);
        showMessage('Sinyaller taranıyor...', 'success');
      }
    }

    // UI Updates
    function updateSignals(signals) {
      if (!signals || signals.length === 0) {
        elements.signals.innerHTML = '<div class="text-center text-gray-500 py-8">Henüz sinyal yok</div>';
        elements.signalCount.textContent = '0';
        return;
      }

      elements.signalCount.textContent = signals.length;
      elements.signals.innerHTML = signals.map(signal => `
        <div class="card rounded-lg p-4 border-l-4 ${signal.direction === 'LONG' ? 'border-green-500' : 'border-red-500'}">
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="font-bold text-lg">${signal.coin}</span>
              <span class="ml-2 px-2 py-1 rounded text-xs ${signal.direction === 'LONG' ? 'bg-green-500' : 'bg-red-500'}">
                ${signal.direction}
              </span>
            </div>
            <div class="text-right">
              <div class="text-sm font-medium ${signal.confidence >= 70 ? 'text-green-400' : signal.confidence >= 60 ? 'text-yellow-400' : 'text-red-400'}">
                %${signal.confidence}
              </div>
              <div class="text-xs text-gray-400">${signal.strategy}</div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 text-sm mb-2">
            <div><span class="text-gray-400">Entry:</span> $${signal.giris}</div>
            <div><span class="text-gray-400">TP:</span> $${signal.tp1}</div>
            <div><span class="text-gray-400">SL:</span> $${signal.sl}</div>
          </div>
          <div class="text-xs text-gray-400">${new Date(signal.timestamp).toLocaleTimeString()}</div>
        </div>
      `).join('');
    }

    function updateSystemStatus(data) {
      elements.balance.textContent = `$${data.system.balance.toFixed(2)}`;
      elements.marketSentiment.textContent = data.system.marketSentiment;
      elements.totalSignals.textContent = data.system.performance.totalSignals;
      elements.totalTrades.textContent = data.system.performance.executedTrades;
      elements.winRate.textContent = `${(data.system.performance.winRate * 100).toFixed(1)}%`;
      elements.lastUpdate.textContent = new Date().toLocaleTimeString();

      // Update positions
      if (data.positions && data.positions.length > 0) {
        elements.positionCount.textContent = data.positions.length;
        elements.positions.innerHTML = data.positions.map(pos => `
          <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
            <div>
              <div class="font-medium">${pos.symbol}</div>
              <div class="text-sm ${pos.side === 'long' ? 'text-green-400' : 'text-red-400'}">
                ${pos.side} • ${parseFloat(pos.contracts).toFixed(4)}
              </div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="closePosition('${pos.symbol}', '${pos.side}', ${parseFloat(pos.contracts)})">
              Kapat
            </button>
          </div>
        `).join('');
      } else {
        elements.positionCount.textContent = '0';
        elements.positions.innerHTML = '<div class="text-center text-gray-500 py-4">Açık pozisyon yok</div>';
      }
    }

    function updateUIConfig(config) {
      document.getElementById('confMin').value = CONFIG.minConfidenceForAuto || 60;
      document.getElementById('orderType').value = CONFIG.orderType || 'limit';
      document.getElementById('leverage').value = CONFIG.leverage || 10;
      document.getElementById('riskProfile').value = CONFIG.riskProfile || 'balanced';
      document.getElementById('scalp').checked = CONFIG.scalpMode || false;
      document.getElementById('autotrade').checked = CONFIG.autotradeMaster || false;
      
      if (config.strategies) {
        document.getElementById('stgBreakout').checked = config.strategies.breakout !== false;
        document.getElementById('stgTrend').checked = config.strategies.trendfollow !== false;
        document.getElementById('stgPump').checked = config.strategies.pumpdump !== false;
      }
    }

    // Event Listeners
    function setupEventListeners() {
      document.getElementById('btnScan').addEventListener('click', scanSignals);
      document.getElementById('btnRefresh').addEventListener('click', loadSystemStatus);
      
      document.getElementById('btnManualTrade').addEventListener('click', async () => {
        const symbol = document.getElementById('manSymbol').value;
        const direction = document.getElementById('manDirection').value;
        const amount = parseFloat(document.getElementById('manAmount').value);
        const price = parseFloat(document.getElementById('manPrice').value) || undefined;
        const orderType = document.getElementById('manType').value;

        const result = await apiCall('/api/trade/manual', {
          method: 'POST',
          body: JSON.stringify({
            symbol,
            direction,
            amount,
            giris: price,
            orderType
          })
        });

        document.getElementById('manMsg').textContent = result.success ? 
          'İşlem gönderildi' : result.error || 'İşlem hatası';
      });

      document.getElementById('btnSaveCfg').addEventListener('click', async () => {
        const config = {
          minConfidenceForAuto: parseInt(document.getElementById('confMin').value),
          orderType: document.getElementById('orderType').value,
          leverage: parseInt(document.getElementById('leverage').value),
          marginPercent: 5, // Fixed for now
          riskProfile: document.getElementById('riskProfile').value,
          scalpMode: document.getElementById('scalp').checked,
          autotradeMaster: document.getElementById('autotrade').checked,
          strategies: {
            breakout: document.getElementById('stgBreakout').checked,
            trendfollow: document.getElementById('stgTrend').checked,
            pumpdump: document.getElementById('stgPump').checked
          }
        };

        const result = await apiCall('/api/config/update', {
          method: 'POST',
          body: JSON.stringify(config)
        });

        document.getElementById('cfgMsg').textContent = result.success ? 
          'Ayarlar kaydedildi' : result.error || 'Kaydetme hatası';
      });

      document.getElementById('btnLogout').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '/';
      });
    }

    // Global functions
    async function closePosition(symbol, side, contracts) {
      const result = await apiCall('/api/position/close', {
        method: 'POST',
        body: JSON.stringify({ symbol, side, contracts })
      });

      if (result.success) {
        showMessage('Pozisyon kapatıldı', 'success');
        loadSystemStatus();
      } else {
        showMessage(result.error || 'Kapatma hatası', 'error');
      }
    }

    function showMessage(message, type = 'info') {
      const msg = document.createElement('div');
      msg.className = `fixed top-4 right-4 p-4 rounded-lg ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      } text-white z-50`;
      msg.textContent = message;
      
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }

    // Auto-refresh every 30 seconds
    setInterval(loadSystemStatus, 30000);
  </script>
</body>
</html>
