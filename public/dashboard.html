<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Alphason Trader - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{margin:0;font-family:Inter,system-ui;background:#0b0e12;color:#e6edf3}
    header{padding:16px 24px;border-bottom:1px solid #1f2328;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700;color:#58a6ff}
    main{padding:24px;max-width:1100px;margin:0 auto}
    .card{border:1px solid #30363d;border-radius:12px;padding:16px;background:#0d1117;margin-bottom:16px}
    input,button,select{padding:8px 10px;border-radius:8px;border:1px solid #30363d;background:#161b22;color:#e6edf3}
    button{cursor:pointer}
    .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .signal{border:1px solid #21262d;border-radius:10px;padding:12px;background:#0b0f14}
    .ok{color:#3fb950} .warn{color:#d29922}
  </style>
</head>
<body>
<header>
  <div class="brand">ALPHASON DASHBOARD</div>
  <div id="userInfo"></div>
</header>
<main>
  <div class="card">
    <h3>Sistem Durumu</h3>
    <div id="status">Yükleniyor...</div>
    <button onclick="loadStatus()">Durumu Yenile</button>
  </div>

  <div class="card">
    <h3>Tarama</h3>
    <button onclick="scan()">Tarama Yap</button>
    <div id="scanMsg" style="margin-top:8px;opacity:.8"></div>
  </div>

  <div class="card">
    <h3>Manuel Trade</h3>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <input id="symbol" placeholder="BTC/USDT">
      <select id="dir">
        <option value="LONG_BREAKOUT">LONG_BREAKOUT</option>
        <option value="SHORT_BREAKOUT">SHORT_BREAKOUT</option>
      </select>
      <input id="entry" placeholder="Giriş">
      <input id="tp" placeholder="TP">
      <input id="sl" placeholder="SL">
      <button onclick="manualTrade()">Gönder</button>
    </div>
  </div>

  <div class="card">
    <h3>Stratejiler</h3>
    <div id="strategies">Yükleniyor...</div>
  </div>

  <div class="row" id="signals"></div>
</main>
<script>
const token = localStorage.getItem('token');
if(!token){ alert('Token yok, önce giriş yapın.'); window.location.href='index.html'; }

async function api(path, method='GET', body=null){
  const res = await fetch(path,{
    method,
    headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token },
    body: body?JSON.stringify(body):undefined
  });
  return await res.json();
}

async function loadStatus(){
  const r = await api('/api/status');
  if(!r.success){ document.getElementById('status').innerText='Hata: '+(r.error||''); return; }
  document.getElementById('status').innerText=`Sinyal: ${r.signals.length} | Pozisyon: ${r.positions.length}`;
  renderSignals(r.signals);
}

async function scan(){
  const r = await api('/api/signals/scan','POST');
  if(!r.success){ document.getElementById('scanMsg').innerText='Hata: '+(r.error||''); return; }
  document.getElementById('scanMsg').innerText=`${r.signals.length} sinyal bulundu.`;
  renderSignals(r.signals);
}

async function manualTrade(){
  const body={
    ccxt_symbol:document.getElementById('symbol').value||'BTC/USDT',
    taraf:document.getElementById('dir').value,
    giris:parseFloat(document.getElementById('entry').value||'0'),
    tp1:parseFloat(document.getElementById('tp').value||'0'),
    sl:parseFloat(document.getElementById('sl').value||'0'),
    confidence:90, positionSize:1.0
  };
  const r = await api('/api/trade/manual','POST',body);
  alert(r.success?'Manuel trade gönderildi':'Hata: '+(r.error||''));
}

async function loadConfig(){
  const r = await api('/api/user/config');
  if(!r.success){ document.getElementById('strategies').innerText='Config yüklenemedi'; return; }
  const allowed = r.config.allowedStrategies.split(',');
  document.getElementById('strategies').innerText='Aktif stratejiler: '+allowed.join(', ');
}

function renderSignals(list){
  const box=document.getElementById('signals'); box.innerHTML='';
  list.forEach(s=>{
    const el=document.createElement('div'); el.className='signal';
    el.innerHTML=`<div><b>${s.ccxt_symbol}</b> — ${s.taraf}</div>
      <div>Giriş: ${s.giris} • TP: ${s.tp1} • SL: ${s.sl}</div>
      <div>Güven: <span class="${s.confidence>=80?'ok':'warn'}">${s.confidence}%</span> • Kalite: ${s.signalQuality}</div>
      <div>RR: ${s.riskReward} • ADX: ${s.adx} • RSI: ${s.rsi}</div>
      <div style="opacity:.8">${s.tuyo}</div>`;
    box.appendChild(el);
  });
}

// Başlangıçta yükle
loadStatus();
loadConfig();
</script>
</body>
</html>
