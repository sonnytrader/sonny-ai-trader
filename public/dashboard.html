<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ALPHASON TRADER</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .signal-long {
            border-left: 4px solid #10B981;
        }
        .signal-short {
            border-left: 4px solid #EF4444;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-blue-400">ALPHASON TRADER</h1>
                    <div class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="/dashboard.html" class="text-blue-400 border-b-2 border-blue-400 px-3 py-2 text-sm font-medium">Dashboard</a>
                        <a href="/backtesting.html" class="text-gray-300 hover:text-white px-3 py-2 text-sm font-medium">Backtesting</a>
                        <a href="/settings.html" class="text-gray-300 hover:text-white px-3 py-2 text-sm font-medium">Ayarlar</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-sm text-gray-300"></span>
                    <button id="btnLogout" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md text-sm">Çıkış</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- System Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Toplam Bakiye</p>
                        <p id="totalBalance" class="text-2xl font-bold text-green-400">$0.00</p>
                    </div>
                    <i class="fas fa-wallet text-green-400 text-xl"></i>
                </div>
            </div>
            
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Açık Pozisyonlar</p>
                        <p id="openPositions" class="text-2xl font-bold text-blue-400">0</p>
                    </div>
                    <i class="fas fa-chart-line text-blue-400 text-xl"></i>
                </div>
            </div>
            
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Win Rate</p>
                        <p id="winRate" class="text-2xl font-bold text-yellow-400">0%</p>
                    </div>
                    <i class="fas fa-trophy text-yellow-400 text-xl"></i>
                </div>
            </div>
            
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Market Sentiment</p>
                        <p id="marketSentiment" class="text-2xl font-bold text-purple-400">-</p>
                    </div>
                    <i class="fas fa-globe text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Real-time Signals -->
                <div class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Gerçek Zamanlı Sinyaller</h2>
                        <div class="flex space-x-3">
                            <button id="btnScan" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-search mr-2"></i>Tara
                            </button>
                            <button id="btnAutoTrade" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-robot mr-2"></i>Oto Trade
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4 flex space-x-4">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-300">LONG</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-300">SHORT</span>
                        </div>
                    </div>
                    
                    <div id="signalsContainer" class="space-y-4 max-h-96 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-wave-square text-4xl mb-4"></i>
                            <p>Sinyal taraması başlatılmadı</p>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6">Performans Grafiği</h2>
                    <div class="h-64">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Active Positions -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6">Aktif Pozisyonlar</h2>
                    <div id="positionsContainer" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-box-open text-2xl mb-2"></i>
                            <p class="text-sm">Açık pozisyon bulunmuyor</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6">Hızlı İşlemler</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <input id="quickSymbol" type="text" placeholder="BTCUSDT" 
                                   class="bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm">
                            <select id="quickDirection" class="bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm">
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input id="quickAmount" type="number" placeholder="Miktar" 
                                   class="bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm">
                            <input id="quickPrice" type="number" placeholder="Fiyat (opsiyonel)" 
                                   class="bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm">
                        </div>
                        <button id="btnQuickTrade" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded-md text-sm">
                            <i class="fas fa-bolt mr-2"></i>Hızlı İşlem
                        </button>
                        <p id="quickTradeMessage" class="text-xs text-gray-400 text-center"></p>
                    </div>
                </div>

                <!-- System Status -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6">Sistem Durumu</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">API Bağlantısı</span>
                            <span id="apiStatus" class="px-2 py-1 rounded text-xs bg-red-500">Bağlı Değil</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Son Güncelleme</span>
                            <span id="lastUpdate" class="text-sm text-gray-300">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Toplam İşlem</span>
                            <span id="totalTrades" class="text-sm text-gray-300">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Scanner Durumu</span>
                            <span id="scannerStatus" class="px-2 py-1 rounded text-xs bg-yellow-500">Pasif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Detail Modal -->
    <div id="signalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Sinyal Detayı</h3>
                <button onclick="closeSignalModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="signalModalContent"></div>
            <div class="mt-6 flex space-x-3">
                <button onclick="executeSignal()" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded-md">
                    İşlem Yap
                </button>
                <button onclick="closeSignalModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-md">
                    Kapat
                </button>
            </div>
        </div>
    </div>

    <script>
        // Token kontrolü
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }

        class Dashboard {
            constructor() {
                this.token = localStorage.getItem('authToken');
                this.ws = null;
                this.performanceChart = null;
                this.autoTradeEnabled = false;
                this.isScanning = false;
                this.currentSignals = [];
                
                if (!this.token) {
                    window.location.href = '/login.html';
                    return;
                }

                this.initialize();
            }

            async initialize() {
                await this.loadUserInfo();
                await this.loadDashboardData();
                this.initializeWebSocket();
                this.initializeChart();
                this.setupEventListeners();
                
                // Auto-refresh every 30 seconds
                setInterval(() => this.loadDashboardData(), 30000);
            }

            async loadUserInfo() {
                try {
                    const response = await fetch('/api/user', {
                        headers: { 
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.user) {
                            document.getElementById('userInfo').textContent = 
                                `${data.user.email} (${data.user.plan})`;
                        }
                    } else if (response.status === 401) {
                        this.handleUnauthorized();
                    }
                } catch (error) {
                    console.error('Kullanıcı bilgisi yüklenemedi:', error);
                    this.showNotification('Kullanıcı bilgisi yüklenemedi', 'error');
                }
            }

            async loadDashboardData() {
                try {
                    const [statusResponse, signalsResponse] = await Promise.all([
                        fetch('/api/system/status', { 
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            } 
                        }),
                        fetch('/api/signals', { 
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            } 
                        })
                    ]);

                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        this.updateStatusCards(statusData);
                    } else if (statusResponse.status === 401) {
                        this.handleUnauthorized();
                    }

                    if (signalsResponse.ok) {
                        const signalsData = await signalsResponse.json();
                        this.updateSignals(signalsData.signals || []);
                    }

                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR');
                    
                } catch (error) {
                    console.error('Dashboard verileri yüklenemedi:', error);
                    this.showNotification('Dashboard verileri yüklenemedi', 'error');
                }
            }

            updateStatusCards(data) {
                if (data.status) {
                    document.getElementById('totalBalance').textContent = `$${data.status.balance.toFixed(2)}`;
                    document.getElementById('winRate').textContent = `${(data.status.performance.winRate * 100).toFixed(1)}%`;
                    document.getElementById('marketSentiment').textContent = data.status.marketSentiment;
                    document.getElementById('totalTrades').textContent = data.status.performance.executedTrades;
                }
                
                if (data.config) {
                    // Update API status
                    const apiStatus = document.getElementById('apiStatus');
                    apiStatus.className = data.config.isApiConfigured ? 
                        'px-2 py-1 rounded text-xs bg-green-500' : 
                        'px-2 py-1 rounded text-xs bg-red-500';
                    apiStatus.textContent = data.config.isApiConfigured ? 'Bağlı' : 'Bağlı Değil';
                }
            }

            updateSignals(signals) {
                this.currentSignals = signals;
                const container = document.getElementById('signalsContainer');
                
                if (!signals || signals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-wave-square text-4xl mb-4"></i>
                            <p>Henüz sinyal bulunmuyor</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = signals.slice(0, 10).map(signal => `
                    <div class="glass-card rounded-lg p-4 fade-in signal-${signal.direction.toLowerCase()}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="font-bold text-lg">${signal.coin}</span>
                                <span class="px-2 py-1 rounded text-xs ${signal.direction === 'LONG' ? 'bg-green-500' : 'bg-red-500'}">
                                    ${signal.direction}
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium ${signal.confidence >= 70 ? 'text-green-400' : signal.confidence >= 60 ? 'text-yellow-400' : 'text-red-400'}">
                                    %${signal.confidence}
                                </div>
                                <div class="text-xs text-gray-400">${signal.strategy}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 text-sm mb-3">
                            <div><span class="text-gray-400">Entry:</span> $${signal.giris}</div>
                            <div><span class="text-gray-400">TP:</span> $${signal.tp1}</div>
                            <div><span class="text-gray-400">SL:</span> $${signal.sl}</div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-400">
                                ${new Date(signal.timestamp).toLocaleTimeString('tr-TR')}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="dashboard.showSignalDetail('${signal.id}')" 
                                        class="text-xs bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded">
                                    Detay
                                </button>
                                ${this.autoTradeEnabled ? '' : `
                                <button onclick="dashboard.executeManualTrade('${signal.id}')" 
                                        class="text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">
                                    Trade
                                </button>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updatePositions(positions) {
                const container = document.getElementById('positionsContainer');
                
                if (!positions || positions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-box-open text-2xl mb-2"></i>
                            <p class="text-sm">Açık pozisyon bulunmuyor</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = positions.map(position => `
                    <div class="glass-card rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${position.symbol}</span>
                            <span class="px-2 py-1 rounded text-xs ${position.side === 'long' ? 'bg-green-500' : 'bg-red-500'}">
                                ${position.side.toUpperCase()}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                            <div>Miktar: ${parseFloat(position.contracts).toFixed(4)}</div>
                            <div>Entry: $${parseFloat(position.entryPrice).toFixed(2)}</div>
                        </div>
                        <button onclick="dashboard.closePosition('${position.symbol}', '${position.side}', ${position.contracts})" 
                                class="w-full mt-2 bg-red-600 hover:bg-red-500 py-1 rounded text-xs">
                            Pozisyonu Kapat
                        </button>
                    </div>
                `).join('');
            }

            initializeChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                this.performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7'],
                        datasets: [{
                            label: 'Portföy Değeri',
                            data: [1000, 1200, 1100, 1300, 1250, 1400, 1500],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#9CA3AF' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#9CA3AF' }
                            }
                        }
                    }
                });
            }

            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}`);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.ws.send(JSON.stringify({ type: 'auth', token: this.token }));
                    document.getElementById('scannerStatus').className = 'px-2 py-1 rounded text-xs bg-green-500';
                    document.getElementById('scannerStatus').textContent = 'Aktif';
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'signal_list') {
                            this.updateSignals(data.data);
                        }
                        if (data.type === 'system_status') {
                            this.updateStatusCards({ status: data.data });
                        }
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    document.getElementById('scannerStatus').className = 'px-2 py-1 rounded text-xs bg-red-500';
                    document.getElementById('scannerStatus').textContent = 'Bağlantı Kesildi';
                    setTimeout(() => this.initializeWebSocket(), 3000);
                };
            }

            setupEventListeners() {
                // Scan button
                document.getElementById('btnScan').addEventListener('click', () => {
                    this.startScan();
                });

                // Auto trade toggle
                document.getElementById('btnAutoTrade').addEventListener('click', () => {
                    this.toggleAutoTrade();
                });

                // Quick trade
                document.getElementById('btnQuickTrade').addEventListener('click', () => {
                    this.executeQuickTrade();
                });

                // Logout
                document.getElementById('btnLogout').addEventListener('click', () => {
                    this.logout();
                });
            }

            async startScan() {
                if (this.isScanning) return;
                
                this.isScanning = true;
                const btnScan = document.getElementById('btnScan');
                btnScan.innerHTML = '<div class="loading-spinner"></div>';
                btnScan.disabled = true;

                try {
                    const response = await fetch('/api/scan/BTC', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        this.showNotification('Market taraması başlatıldı', 'success');
                    } else {
                        this.showNotification('Tarama başlatılamadı', 'error');
                    }
                } catch (error) {
                    this.showNotification('Tarama başlatılamadı', 'error');
                } finally {
                    setTimeout(() => {
                        this.isScanning = false;
                        btnScan.innerHTML = '<i class="fas fa-search mr-2"></i>Tara';
                        btnScan.disabled = false;
                    }, 5000);
                }
            }

            toggleAutoTrade() {
                this.autoTradeEnabled = !this.autoTradeEnabled;
                const btn = document.getElementById('btnAutoTrade');
                
                if (this.autoTradeEnabled) {
                    btn.classList.remove('bg-green-600', 'hover:bg-green-500');
                    btn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
                    btn.innerHTML = '<i class="fas fa-pause mr-2"></i>Oto Trade Durdur';
                    this.showNotification('Oto trade aktif edildi', 'success');
                } else {
                    btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
                    btn.classList.add('bg-green-600', 'hover:bg-green-500');
                    btn.innerHTML = '<i class="fas fa-robot mr-2"></i>Oto Trade';
                    this.showNotification('Oto trade durduruldu', 'warning');
                }
            }

            async executeQuickTrade() {
                const symbol = document.getElementById('quickSymbol').value;
                const direction = document.getElementById('quickDirection').value;
                const amount = document.getElementById('quickAmount').value;
                const price = document.getElementById('quickPrice').value;

                if (!symbol || !amount) {
                    this.showNotification('Symbol ve miktar zorunludur', 'error');
                    return;
                }

                const tradeData = {
                    symbol: symbol.includes(':') ? symbol : `${symbol}:USDT`,
                    direction,
                    amount: parseFloat(amount),
                    giris: price ? parseFloat(price) : undefined,
                    orderType: price ? 'limit' : 'market'
                };

                try {
                    const response = await fetch('/api/trading/manual', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(tradeData)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification('İşlem gönderildi', 'success');
                        document.getElementById('quickTradeMessage').textContent = 'İşlem başarıyla gönderildi';
                        document.getElementById('quickSymbol').value = '';
                        document.getElementById('quickAmount').value = '';
                        document.getElementById('quickPrice').value = '';
                    } else {
                        this.showNotification(result.error || 'İşlem hatası', 'error');
                        document.getElementById('quickTradeMessage').textContent = result.error;
                    }
                } catch (error) {
                    this.showNotification('İşlem gönderilemedi', 'error');
                    document.getElementById('quickTradeMessage').textContent = 'Sunucu hatası';
                }
            }

            showSignalDetail(signalId) {
                const signal = this.currentSignals.find(s => s.id === signalId);
                if (!signal) return;

                const modal = document.getElementById('signalModal');
                const content = document.getElementById('signalModalContent');
                
                content.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-medium">Symbol:</span>
                            <span>${signal.coin}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Strateji:</span>
                            <span>${signal.strategy}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Yön:</span>
                            <span class="${signal.direction === 'LONG' ? 'text-green-400' : 'text-red-400'}">${signal.direction}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Güven:</span>
                            <span class="${signal.confidence >= 70 ? 'text-green-400' : signal.confidence >= 60 ? 'text-yellow-400' : 'text-red-400'}">%${signal.confidence}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Entry:</span>
                            <span>$${signal.giris}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Take Profit:</span>
                            <span class="text-green-400">$${signal.tp1}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Stop Loss:</span>
                            <span class="text-red-400">$${signal.sl}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Risk/Reward:</span>
                            <span>1:${signal.riskReward.toFixed(2)}</span>
                        </div>
                        ${signal.narrative ? `
                        <div class="mt-4 p-3 bg-gray-800 rounded">
                            <p class="text-sm text-gray-300">${signal.narrative.why}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            async executeManualTrade(signalId) {
                const signal = this.currentSignals.find(s => s.id === signalId);
                if (!signal) return;

                try {
                    const response = await fetch('/api/trading/manual', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(signal)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`${signal.coin} işlemi başlatıldı`, 'success');
                        this.loadDashboardData();
                    } else {
                        this.showNotification(result.error || 'İşlem hatası', 'error');
                    }
                } catch (error) {
                    this.showNotification('İşlem gönderilemedi', 'error');
                }
            }

            async closePosition(symbol, side, contracts) {
                if (!confirm('Pozisyonu kapatmak istediğinizden emin misiniz?')) return;

                try {
                    const response = await fetch('/api/position/close', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ symbol, side, contracts: parseFloat(contracts) })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification('Pozisyon kapatıldı', 'success');
                        this.loadDashboardData();
                    } else {
                        this.showNotification(result.error || 'Kapatma hatası', 'error');
                    }
                } catch (error) {
                    this.showNotification('Pozisyon kapatılamadı', 'error');
                }
            }

            async logout() {
                try {
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                }
            }

            handleUnauthorized() {
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                } text-white`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Global functions for modal
        function closeSignalModal() {
            document.getElementById('signalModal').classList.add('hidden');
            document.getElementById('signalModal').classList.remove('flex');
        }

        function executeSignal() {
            closeSignalModal();
        }

        // Initialize dashboard when page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
        });
    </script>
</body>
</html>
